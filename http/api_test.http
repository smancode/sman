### =============================================================================
### SmanAgent 验证服务 API 测试
### =============================================================================
### 服务地址: http://localhost:8080
### 目标分析项目: autoloop
###
### 使用方法：
### 1. 确保验证服务已启动（./scripts/verification-web.sh）
### 2. 点击每个请求左侧的 "Run" 按钮执行
### =============================================================================

@baseUrl = http://localhost:8080
@projectKey = autoloop

### =============================================================================
### 一、专家咨询 API（主要入口）
### =============================================================================
### 说明：通过自然语言查询项目信息，内部使用 BGE-M3 召回 + Reranker 重排

### 1. 专家咨询 - 放款接口
POST {{baseUrl}}/api/verify/expert_consult
Content-Type: application/json

{
  "question": "放款是哪个接口？",
  "projectKey": "{{projectKey}}",
  "topK": 3
}

### 2. 专家咨询 - 还款接口
POST {{baseUrl}}/api/verify/expert_consult
Content-Type: application/json

{
  "question": "有哪些还款相关的 Handler？",
  "projectKey": "{{projectKey}}",
  "topK": 5
}

### 3. 专家咨询 - Handler 接口列表
POST {{baseUrl}}/api/verify/expert_consult
Content-Type: application/json

{
  "question": "项目中有哪些 Handler 接口？",
  "projectKey": "{{projectKey}}",
  "topK": 10
}

### 4. 专家咨询 - 数据库实体
POST {{baseUrl}}/api/verify/expert_consult
Content-Type: application/json

{
  "question": "项目中有哪些数据库实体？它们之间的关系是什么？",
  "projectKey": "{{projectKey}}",
  "topK": 10
}

### 5. 专家咨询 - 数据库表
POST {{baseUrl}}/api/verify/expert_consult
Content-Type: application/json

{
  "question": "项目中有哪些贷款相关的表？",
  "projectKey": "{{projectKey}}",
  "topK": 10
}

### 6. 专家咨询 - 枚举状态
POST {{baseUrl}}/api/verify/expert_consult
Content-Type: application/json

{
  "question": "贷款状态有哪些？",
  "projectKey": "{{projectKey}}",
  "topK": 5
}

### 7. 专家咨询 - 枚举类型
POST {{baseUrl}}/api/verify/expert_consult
Content-Type: application/json

{
  "question": "项目中有哪些枚举类型？分别代表什么含义？",
  "projectKey": "{{projectKey}}",
  "topK": 10
}

### 8. 专家咨询 - 外调接口
POST {{baseUrl}}/api/verify/expert_consult
Content-Type: application/json

{
  "question": "项目调用了哪些外部接口？",
  "projectKey": "{{projectKey}}",
  "topK": 10
}

### 9. 专家咨询 - 公共类和工具
POST {{baseUrl}}/api/verify/expert_consult
Content-Type: application/json

{
  "question": "项目中有哪些公共类和工具类？",
  "projectKey": "{{projectKey}}",
  "topK": 10
}

### 10. 专家咨询 - XML 配置
POST {{baseUrl}}/api/verify/expert_consult
Content-Type: application/json

{
  "question": "项目中有哪些 XML 配置文件？",
  "projectKey": "{{projectKey}}",
  "topK": 10
}

### 11. 专家咨询 - 项目结构
POST {{baseUrl}}/api/verify/expert_consult
Content-Type: application/json

{
  "question": "项目结构是什么样的？",
  "projectKey": "{{projectKey}}",
  "topK": 5
}

### 12. 专家咨询 - 技术栈
POST {{baseUrl}}/api/verify/expert_consult
Content-Type: application/json

{
  "question": "项目用了什么技术栈？",
  "projectKey": "{{projectKey}}",
  "topK": 5
}

### 13. 专家咨询 - 整体架构
POST {{baseUrl}}/api/verify/expert_consult
Content-Type: application/json

{
  "question": "这个项目的整体架构是什么？使用了哪些技术栈？",
  "projectKey": "{{projectKey}}",
  "topK": 10
}

### 14. 专家咨询 - 用户登录
POST {{baseUrl}}/api/verify/expert_consult
Content-Type: application/json

{
  "question": "用户登录验证是怎么实现的？",
  "projectKey": "{{projectKey}}",
  "topK": 5
}

### 15. 专家咨询 - 还款流程
POST {{baseUrl}}/api/verify/expert_consult
Content-Type: application/json

{
  "question": "还款流程是怎样的？有哪些还款方式？",
  "projectKey": "{{projectKey}}",
  "topK": 10
}

### =============================================================================
### 二、分析结果查询 API（12 个分析模块）
### =============================================================================
### 说明：直接查询各分析模块的原始结果，不支持语义搜索

### 16. 查询项目结构 (project_structure)
POST {{baseUrl}}/api/verify/analysis_results
Content-Type: application/json

{
  "module": "project_structure",
  "projectKey": "{{projectKey}}",
  "page": 0,
  "size": 20
}

### 17. 查询技术栈 (tech_stack_detection)
POST {{baseUrl}}/api/verify/analysis_results
Content-Type: application/json

{
  "module": "tech_stack_detection",
  "projectKey": "{{projectKey}}",
  "page": 0,
  "size": 20
}

### 18. 查询 AST 扫描结果 (ast_scanning)
POST {{baseUrl}}/api/verify/analysis_results
Content-Type: application/json

{
  "module": "ast_scanning",
  "projectKey": "{{projectKey}}",
  "page": 0,
  "size": 20
}

### 19. 查询数据库实体 (db_entity_detection)
POST {{baseUrl}}/api/verify/analysis_results
Content-Type: application/json

{
  "module": "db_entity_detection",
  "projectKey": "{{projectKey}}",
  "page": 0,
  "size": 20
}

### 20. 查询 API 入口 (api_entry_scanning)
POST {{baseUrl}}/api/verify/analysis_results
Content-Type: application/json

{
  "module": "api_entry_scanning",
  "projectKey": "{{projectKey}}",
  "page": 0,
  "size": 20
}

### 21. 查询外调接口 (external_api_scanning)
POST {{baseUrl}}/api/verify/analysis_results
Content-Type: application/json

{
  "module": "external_api_scanning",
  "projectKey": "{{projectKey}}",
  "page": 0,
  "size": 20
}

### 22. 查询枚举 (enum_scanning)
POST {{baseUrl}}/api/verify/analysis_results
Content-Type: application/json

{
  "module": "enum_scanning",
  "projectKey": "{{projectKey}}",
  "page": 0,
  "size": 20
}

### 23. 查询公共类 (common_class_scanning)
POST {{baseUrl}}/api/verify/analysis_results
Content-Type: application/json

{
  "module": "common_class_scanning",
  "projectKey": "{{projectKey}}",
  "page": 0,
  "size": 20
}

### 24. 查询 XML 代码 (xml_code_scanning)
POST {{baseUrl}}/api/verify/analysis_results
Content-Type: application/json

{
  "module": "xml_code_scanning",
  "projectKey": "{{projectKey}}",
  "page": 0,
  "size": 20
}

### 25. 查询案例 SOP (case_sop_generation)
POST {{baseUrl}}/api/verify/analysis_results
Content-Type: application/json

{
  "module": "case_sop_generation",
  "projectKey": "{{projectKey}}",
  "page": 0,
  "size": 20
}

### 26. 查询代码走读 (code_walkthrough_generation)
POST {{baseUrl}}/api/verify/analysis_results
Content-Type: application/json

{
  "module": "code_walkthrough_generation",
  "projectKey": "{{projectKey}}",
  "page": 0,
  "size": 20
}

### =============================================================================
### 三、H2 数据库查询 API（调试用）
### =============================================================================
### 说明：直接执行 SQL 查询 H2 数据库，仅用于调试

### 27. 查询向量总数
POST {{baseUrl}}/api/verify/execute_sql
Content-Type: application/json

{
  "sql": "SELECT COUNT(*) as total FROM vector_fragments"
}

### 28. 查询细粒度向量分布
POST {{baseUrl}}/api/verify/execute_sql
Content-Type: application/json

{
  "sql": "SELECT SUBSTR(id, 1, CASE WHEN LOCATE(':', id, 3) > 0 THEN LOCATE(':', id, 3) - 1 ELSE LENGTH(id) END) as type, COUNT(*) as cnt FROM vector_fragments WHERE project_key = '{{projectKey}}' AND id LIKE '%:%' GROUP BY type ORDER BY cnt DESC"
}

### 29. 查看 API 入口向量样本
POST {{baseUrl}}/api/verify/execute_sql
Content-Type: application/json

{
  "sql": "SELECT id, title, content FROM vector_fragments WHERE id LIKE '%api_entry%' LIMIT 10"
}

### 30. 查看数据库实体向量样本
POST {{baseUrl}}/api/verify/execute_sql
Content-Type: application/json

{
  "sql": "SELECT id, title, content FROM vector_fragments WHERE id LIKE '%db_entity%' LIMIT 10"
}

### 31. 查看枚举向量样本
POST {{baseUrl}}/api/verify/execute_sql
Content-Type: application/json

{
  "sql": "SELECT id, title, content FROM vector_fragments WHERE id LIKE '%enum%' LIMIT 10"
}

### 32. 查询分析步骤状态
POST {{baseUrl}}/api/verify/execute_sql
Content-Type: application/json

{
  "sql": "SELECT STEP_NAME, STATUS FROM ANALYSIS_STEP WHERE PROJECT_KEY = '{{projectKey}}'"
}

### 33. 查询项目分析结果
POST {{baseUrl}}/api/verify/execute_sql
Content-Type: application/json

{
  "sql": "SELECT * FROM PROJECT_ANALYSIS"
}

### =============================================================================
### 四、通用查询 API
### =============================================================================

### 34. 查询向量数据（分页）
POST {{baseUrl}}/api/verify/query_vectors
Content-Type: application/json

{
  "page": 0,
  "size": 20
}

### 35. 查询项目列表
POST {{baseUrl}}/api/verify/query_projects
Content-Type: application/json

{
  "page": 0,
  "size": 20
}

### =============================================================================
### API 端点说明
### =============================================================================
### 1. /api/verify/expert_consult
###    - 唯一的对外语义查询入口
###    - 参数：question（问题）、projectKey（项目键）、topK（返回数量）
###
### 2. /api/verify/analysis_results
###    - 查询 12 个分析模块的原始结果
###    - 参数：module（模块名）、projectKey、page、size
###
### 3. /api/verify/execute_sql
###    - 执行安全 SQL（调试用）
###    - 参数：sql（SQL 语句）
###
### 4. /api/verify/query_vectors
###    - 分页查询向量数据
###    - 参数：page、size
###
### 5. /api/verify/query_projects
###    - 分页查询项目列表
###    - 参数：page、size
###
### 6. /api/debug/test-common-class-scanner
###    - 调试公共类扫描器（GET 请求）
###    - 参数：projectPath（可选）
###
### 7. /api/debug/test-external-api-scanner
###    - 调试外调接口扫描器（GET 请求）
###    - 参数：projectPath（可选）
###
### =============================================================================
### 注意事项
### =============================================================================
### 1. 如果 expert_consult 返回"未找到相关代码片段"，请：
###    - 在 IntelliJ IDEA 插件中重新运行"项目分析"
###    - 等待分析完成后再次测试
###
### 2. 配置参数（通过环境变量）：
###    - LLM_API_KEY: LLM API 密钥（必需）
###    - BGE_ENDPOINT: BGE-M3 向量化服务地址
###    - RERANKER_BASE_URL: Reranker 重排服务地址
###    - RERANKER_THRESHOLD: Reranker 相似度阈值（默认 0.1）
###
### 3. 12 个分析模块：
###    - project_structure: 项目结构扫描
###    - tech_stack_detection: 技术栈识别
###    - ast_scanning: AST 扫描
###    - db_entity_detection: 数据库实体扫描
###    - api_entry_scanning: API 入口扫描
###    - external_api_scanning: 外调接口扫描
###    - enum_scanning: 枚举扫描
###    - common_class_scanning: 公共类扫描
###    - xml_code_scanning: XML 代码扫描
###    - case_sop_generation: 案例 SOP 生成
###    - code_vectorization: 代码向量化
###    - code_walkthrough_generation: 代码走读生成
###
### 4. semantic_search 端点：
###    - VectorSearchService 服务已实现
###    - 但目前没有对应的 REST API 控制器
###    - 需要通过 expert_consult 间接使用向量搜索功能
### =============================================================================
