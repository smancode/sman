# SiliconMan Agent 配置文件
# 版本: 1.0.0
# 说明: 基于 Claude Code 的代码分析 Agent 后端

server:
  port: 8080

spring:
  application:
    name: siliconman-agent

  # 完全禁用 DevTools
  devtools:
    restart:
      enabled: false
    add-properties: false

  # Jackson 配置
  jackson:
    serialization:
      indent-output: true
    default-property-inclusion: non_null
    date-format: yyyy-MM-dd'T'HH:mm:ss.SSS'Z'
    time-zone: GMT

# ==================== Claude Code 配置 ====================
claude-code:
  # Claude Code CLI 路径
  # Windows 环境：使用 Windows 原生路径（C:\nvm4w\nodejs\claude.cmd）
  # macOS/Linux 环境：使用绝对路径或环境变量
  # 通过--print模式支持stdio通信
  path: ${CLAUDE_CODE_PATH:claude}

  # 工作目录基础路径
  work-dir-base: ${user.dir}/data/claude-code-workspaces

  # 进程池配置
  pool:
    size: 3                        # 进程池大小（本地开发使用3个，生产环境建议10-15）
    max-lifetime: 1800000          # 进程最大生命周期（30分钟，毫秒）
    health-check-interval: 60000   # 健康检查间隔（1分钟，毫秒）
    warmup: true                   # 启动时预热（创建所有进程）

# ==================== 向量搜索配置 ====================
vector:
  # BGE-M3 配置
  bge-m3:
    # BGE-M3 模型服务地址（需要单独部署）
    endpoint: ${BGE_M3_ENDPOINT:http://localhost:8000}
    model-name: BAAI/bge-m3
    dimension: 1024
    batch-size: 32
    timeout: 30000  # 毫秒

  # BGE-Reranker 配置
  bge-reranker:
    # BGE-Reranker 模型服务地址（需要单独部署）
    endpoint: ${BGE_RERANKER_ENDPOINT:http://localhost:8001}
    model-name: BAAI/bge-reranker-v2-m3
    top-k: 10
    timeout: 10000  # 毫秒

  # 索引配置
  index:
    path: data/vector-index  # 索引存储路径
    auto-build: true        # 自动构建索引
    refresh-interval: 3600000  # 刷新间隔（1小时，毫秒）

  # 搜索配置
  search:
    top-k: 10               # 默认返回结果数
    threshold: 0.0          # 相似度阈值(临时设为0用于测试)
    use-reranker: true      # 是否使用重排序

# ==================== 降级模式配置 ====================
agent:
  fallback:
    enabled: true              # 是否启用降级模式
    auto-detect: true          # 是否自动检测并降级
    duration-minutes: 5        # 临时降级持续时间（分钟）

  # projectKey → projectPath 映射（降级模式和 WebSocket v2 协议需要）
  projects:
    autoloop:
      project-path: /Users/liuchao/projects/autoloop
      description: "AutoLoop 项目"
      language: "java"
      version: "1.0.0"

    # mcfcm-core 项目（Windows 环境）
    mcfcm-core:
      project-path: C:\\dev\\cfpd\\mcfcm-core
      description: "MFCM 核心系统"
      language: "java"
      version: "1.0.0"

    # 示例：银行核心系统
    # bank-core:
    #   project-path: /Users/user/projects/bank-core
    #   description: "银行核心系统"
    #   language: "java"
    #   version: "1.0.0"
    # 示例：支付系统
    # payment-system:
    #   project-path: /Users/user/projects/payment-system
    #   description: "支付系统"
    #   language: "java"
    #   version: "2.1.0"

# ==================== 数据存储配置 ====================
data:
  # 基础路径
  base-path: data

  # MD5 缓存（文件变化检测）
  md5-cache-dir: "./data/file-md5-cache"

# ==================== WebSocket 配置 ====================
websocket:
  # 路径
  path: /ws/analyze

# ==================== 异步线程池配置 ====================
async:
  executor:
    # 通用异步线程池（@Async、CompletableFuture 默认）
    core-size: 10               # 核心线程数
    max-size: 50                # 最大线程数
    queue-capacity: 1000        # 队列容量
    thread-name-prefix: sman-async-  # 线程名前缀

    # 向量索引刷新线程池（单线程顺序执行）
    vector-refresh:
      core-size: 1
      max-size: 1
      queue-capacity: 10
      thread-name-prefix: vector-refresh-

    # WebSocket 消息处理线程池（独立线程池，避免阻塞主业务）
    websocket:
      core-size: 5
      max-size: 20
      queue-capacity: 500
      thread-name-prefix: websocket-async-


# ==================== 日志配置 ====================
logging:
  level:
    root: INFO
    com.siliconman: DEBUG
    org.springframework: INFO
    org.apache: WARN

  # 日志文件
  file:
    name: logs/app.log
    max-size: 100MB
    max-history: 30

  # 日志格式
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"

  # 修复 JUL 桥接问题
  # 禁用 Tomcat 的 JUL → SLF4J 桥接，避免 ClassNotFoundException
  jul-to-slf4j: false

# ==================== 健康检查配置 ====================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics

  endpoint:
    health:
      show-details: always

# ==================== 开发环境配置 ====================
# 开发环境专用配置（生产环境请使用外部配置文件覆盖）
---
spring:
  config:
    activate:
      on-profile: dev

  # 开发环境热部署（禁用，避免自动重启）
  devtools:
    restart:
      enabled: false

logging:
  level:
    com.siliconman: DEBUG

# ==================== 生产环境配置 ====================
---
spring:
  config:
    activate:
      on-profile: prod

logging:
  level:
    root: WARN
    com.siliconman: INFO
