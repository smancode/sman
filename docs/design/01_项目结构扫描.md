# 01 - 项目结构扫描

## 目标

为 SmanAgent 项目添加项目结构扫描能力，获取项目的基本架构信息，包括模块划分、包结构、分层架构等。

## 参考

- knowledge-graph-system 的 `ProjectInitializer.java`
- knowledge-graph-system 的 `ArchitectureAnalyzer.java`
- opencode 的 `/init` 实现

## 核心功能

### 1. 模块结构识别

**目标**：识别项目的模块结构类型

**输出**：
- `single-module` - 单模块项目
- `multi-module-flat` - 平面多模块（所有模块在同一父目录）
- `multi-module-nested` - 嵌套多模块（模块在不同层级）

**实现策略**：
```kotlin
// 参考 ArchitectureAnalyzer.findJavaSourcePaths()
// 1. 递归查找所有 */src/main/java 目录
// 2. 根据目录结构判断模块类型
// 3. 排除 build/、target/、.git/、node_modules/ 等目录
```

### 2. 模块信息收集

**目标**：收集每个模块的详细信息

**输出**：
- 模块名称
- Java 源码路径
- 根包名

**实现策略**：
```kotlin
// 参考 ArchitectureAnalyzer.inferModuleName()
// 从路径推断模块名：.../module-name/src/main/java -> module-name
// 如果是根模块，返回 "main"
```

### 3. 包结构分析

**目标**：收集所有包名并推测根包

**输出**：
- 所有包名集合
- 推测的根包名（最常见的前两级包名）

**实现策略**：
```kotlin
// 参考 ArchitectureAnalyzer.collectAllPackages()
// 1. 遍历所有 Java 源码目录
// 2. 将目录路径转换为包名
// 3. 统计最频繁的包名前缀作为根包
```

### 4. 分层架构分析

**目标**：识别项目的分层架构

**输出**：
- 是否有分层结构
- Controller 包路径和数量
- Service 包路径和数量
- Repository/Mapper 包路径和数量
- Entity/Model 包路径和数量

**实现策略**：
```kotlin
// 参考 ArchitectureAnalyzer.analyzeLayerStructure()
// 1. 扫描所有 .java 文件
// 2. 通过注解识别分层：
//    - @RestController/@Controller -> Controller
//    - @Service -> Service
//    - @Repository/extends JpaRepository/extends Mapper -> Repository
//    - @Entity/@Table/entity或model目录下的类 -> Entity
```

### 5. 中间件统计

**目标**：统计中间件入口数量

**输出**：
- HTTP 入口数量（@RestController、@RequestMapping）
- Dubbo 服务数量（@DubboService）
- MQ 监听器数量（@KafkaListener、@RocketMQMessageListener、@JmsListener）
- 定时任务数量（@XxlJob、@Scheduled、@EnableScheduling）

**实现策略**：
```kotlin
// 参考 ArchitectureAnalyzer.countMiddlewareEntrances()
// 扫描所有 .java 文件，统计特定注解的出现次数
```

### 6. 代码规模统计

**目标**：统计代码规模

**输出**：
- Java 文件数量
- XML 文件数量
- 总行数

**实现策略**：
```kotlin
// 参考 ArchitectureAnalyzer.calculateCodeStats()
// 1. 递归统计 .java 文件数量
// 2. 递归统计 resources 目录下的 .xml 文件数量
// 3. 累加所有 .java 文件的行数
```

## Kotlin 实现

### 文件位置

```
src/main/kotlin/com/smancode/smanagent/analyzer/
├── ProjectStructureAnalyzer.kt       # 主分析器
├── model/
│   ├── ModuleInfo.kt                 # 模块信息
│   ├── LayerInfo.kt                  # 分层信息
│   ├── MiddlewareStats.kt            # 中间件统计
│   └── CodeStats.kt                  # 代码统计
```

### 核心接口

```kotlin
interface ProjectStructureAnalyzer {
    /**
     * 分析项目结构
     * @param projectPath 项目路径
     * @return 项目结构信息
     */
    fun analyze(projectPath: Path): ProjectStructure
}

data class ProjectStructure(
    val moduleStructure: ModuleStructure,
    val modules: Set<ModuleInfo>,
    val allPackages: Set<String>,
    val rootPackage: String,
    val layerInfo: LayerInfo,
    val middlewareStats: MiddlewareStats,
    val codeStats: CodeStats
)

enum class ModuleStructure {
    SINGLE_MODULE,
    MULTI_MODULE_FLAT,
    MULTI_MODULE_NESTED,
    UNKNOWN
}
```

## 与 knowledge-graph-system 的差异

### 可以借鉴的部分

1. **多模块项目处理策略**
   - 递归查找 `*/src/main/java` 目录
   - 智能推断模块名和根包名

2. **分层架构识别**
   - 通过注解识别 Controller、Service、Repository
   - 统计各层的包路径和数量

3. **中间件统计**
   - 通过注解统计 HTTP、Dubbo、MQ、定时任务入口

### 需要调整的部分

1. **语言适配**
   - Java → Kotlin
   - 文件扫描方式调整（Kotlin 更简洁）

2. **IntelliJ PSI 集成**
   - 利用 PSI 获取更准确的包名和类信息
   - 不需要文件内容解析，直接通过 PSI 获取注解

3. **存储方式**
   - knowledge-graph-system 存入文件
   - SmanAgent 存入向量库（待第 11 节设计）

## 专家知识库

### 关键问题

1. **如何判断模块结构类型？**
   - 如果 `src/main/java` 目录数量 = 1，则是单模块
   - 如果所有 `src/main/java` 的父目录在同一层级，则是平面多模块
   - 否则是嵌套多模块

2. **如何准确推断根包名？**
   - 方法1：读取第一个 .java 文件的 package 声明
   - 方法2：统计所有包名，取最频繁的前两级作为根包
   - 建议：两种方法结合，提高准确率

3. **如何处理 Kotlin 项目？**
   - Kotlin 项目的源码目录是 `src/main/kotlin`
   - 包名推断逻辑相同
   - 注解识别也相同（Kotlin 使用相同的注解）

## 待解决的问题

1. **增量更新**
   - 当项目结构变化时，如何增量更新？
   - knowledge-graph-system 使用文件修改时间生成版本号
   - SmanAgent 是否需要类似机制？

2. **缓存策略**
   - 项目结构信息是否需要缓存？
   - 缓存在哪里？内存？文件？

3. **错误处理**
   - 如果项目路径不存在？
   - 如果没有找到 Java/Kotlin 源码目录？
   - 如果 PSI 解析失败？

4. **性能优化**
   - 大型项目文件数量多，如何优化扫描速度？
   - 是否需要并发扫描？

## 下一步

- [x] 实现基础的项目结构扫描
- [x] 集成 PSI 获取更准确的信息
- [x] 设计存储格式（向量库 Schema）
- [x] 编写单元测试

---

## ✅ 实现完成 (2026-01-30)

### 实现文件

- **位置**: `src/main/kotlin/com/smancode/smanagent/analysis/structure/ProjectStructureScanner.kt`
- **测试**: 所有测试通过 (196 tests passed)

### 实现功能

1. ✅ **模块检测** - Maven/Gradle 模块识别
2. ✅ **包结构扫描** - 自动识别所有包和类数量
3. ✅ **分层架构分析** - 识别 controller/service/domain/infrastructure 等层次
4. ✅ **代码统计** - 文件数量和代码行数统计

### 核心数据类

```kotlin
@Serializable
data class ProjectStructure(
    val rootPath: String,
    val modules: List<ModuleInfo>,
    val packages: List<PackageInfo>,
    val layers: List<LayerInfo>,
    val totalFiles: Int,
    val totalLines: Long
)

@Serializable
data class ModuleInfo(
    val name: String,
    val type: ModuleType,  // MAVEN, GRADLE
    val path: String
)

@Serializable
data class LayerInfo(
    val name: String,
    val type: LayerType,   // PRESENTATION, SERVICE, DOMAIN, INFRASTRUCTURE, etc.
    val path: String,
    val packagePath: String
)
```

### 简化策略

- 使用 `Files.walk()` 遍历目录结构
- 正则表达式匹配包名模式识别层次
- 不依赖完整 PSI，降低复杂度

### 验证状态

```bash
./gradlew test
# BUILD SUCCESSFUL - 196 tests completed
```
