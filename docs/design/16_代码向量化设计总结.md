# ä»£ç å‘é‡åŒ–è®¾è®¡æ›´æ–°æ€»ç»“

## ğŸ“‹ æ›´æ–°å®Œæˆ

å·²æˆåŠŸå°†ä»£ç å‘é‡åŒ–è®¾è®¡æ•´åˆåˆ° `11_è¯­ä¹‰åŒ–å‘é‡åŒ–.md` æ–‡æ¡£ä¸­ã€‚

## âœ… æ–°å¢å†…å®¹

### 1. ä»£ç å‘é‡åŒ–ç« èŠ‚ï¼ˆ5 ç§ç±»å‹ï¼‰

#### 1.1 ç±»å‘é‡åŒ–
```
ã€ç±»å®šä¹‰ã€‘
ç±»å: LoanPenaltyCalculator
å®Œæ•´ç­¾å: public class LoanPenaltyCalculator implements ICostService
æ³¨è§£: @Service("loanPenaltyService"), @Slf4j

ã€ä¸šåŠ¡æè¿°ã€‘
è´Ÿè´£è®¡ç®—è´·æ¬¾ä¸šåŠ¡ä¸­çš„å„ç±»ç½šæ¯

ã€æ ¸å¿ƒæ•°æ®æ¨¡å‹ã€‘
- overdueRate (BigDecimal): é€¾æœŸåˆ©ç‡
- baseAmount (BigDecimal): è®¡ç®—åŸºæ•°
- penaltyType (Integer): ç½šæ¯ç±»å‹æšä¸¾å€¼

ã€åŒ…å«åŠŸèƒ½ã€‘
- calculateOverdue(): è®¡ç®—é€¾æœŸé‡‘é¢
- adjustRate(): è°ƒæ•´è´¹ç‡
```

#### 1.2 æ–¹æ³•å‘é‡åŒ–ï¼ˆåŒ…å«æºç ï¼‰
```
ã€ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‘
ç±»å: AccountValidator
ç±»æè¿°: å¤„ç†ç”¨æˆ·é“¶è¡Œè´¦æˆ·çš„å¼€æˆ·æ ¡éªŒé€»è¾‘

ã€å½“å‰æ–¹æ³•ã€‘
æ–¹æ³•å: accountValid
æ–¹æ³•æ³¨é‡Š: æ ¡éªŒè´¦å·å’Œæˆ·åæ˜¯å¦åŒ¹é…
ä»£ç å†…å®¹:
public boolean accountValid(String accountName, String error) {
    // ... å®Œæ•´æºç  ...
}
```

#### 1.3 Enum å‘é‡åŒ–
```
ã€æšä¸¾å®šä¹‰ã€‘
æšä¸¾å: LoanStatus
æè¿°: è´·æ¬¾ç”³è¯·æµç¨‹ä¸­çš„å„ç§çŠ¶æ€æµè½¬å®šä¹‰

ã€å­—å…¸æ˜ å°„ã€‘
- APPLIED (1): å·²æäº¤ç”³è¯·ï¼Œç­‰å¾…åˆå®¡
- REJECTED (4): å®¡æ ¸æ‹’ç»
- PASSED (5): å®¡æ‰¹é€šè¿‡
```

#### 1.4 XML å‘é‡åŒ–ï¼ˆMyBatis Mapperï¼‰
```
ã€SQL æ˜ å°„ã€‘
Mapperæ–‡ä»¶: CustomerMapper.xml
æ“ä½œID: queryByPhone
æ“ä½œç±»å‹: SELECT

ã€SQL é€»è¾‘ã€‘
SELECT * FROM t_customer WHERE phone = #{phone}

ã€æ³¨é‡Š/æè¿°ã€‘
æ ¹æ®æ‰‹æœºå·ç²¾ç¡®æŸ¥æ‰¾å®¢æˆ·ä¿¡æ¯
```

#### 1.5 XML å‘é‡åŒ–ï¼ˆé…ç½®æ–‡ä»¶ï¼‰
```
ã€äº¤æ˜“æµç¨‹å®šä¹‰ã€‘
äº¤æ˜“åç§°: è´·æ¬¾å‘æ”¾ (Code: 1001)
äº¤æ˜“ç±»å‹: jbo.acct.ACCT_PUTOUT

ã€æ‰§è¡Œæ­¥éª¤ã€‘
æ­¥éª¤ 1 (load): æ•°æ®åŠ è½½ -> ...PutOutDataLoader
æ­¥éª¤ 2 (create): åˆ›å»ºå€Ÿæ® -> ...BusinessDuebillCreate
...
æ­¥éª¤ 10 (execute): è®°è´¦æ‰§è¡Œ (BookKeepExecutor)
```

### 2. XML é€šç”¨æ‰å¹³åŒ–ç­–ç•¥

**æ ¸å¿ƒç†å¿µ**ï¼šä¸éœ€è¦ä¸ºæ¯ç§ XML å†™ä¸€ä¸ªå¤æ‚çš„ Parser

#### æ‰å¹³åŒ–æ­¥éª¤

1. **è¯†åˆ«æ ¹èŠ‚ç‚¹å¹¶æ‰“æ ‡**
   - `<JournalGroup>` â†’ "ä¼šè®¡é…ç½®"
   - `<TransactionConfig>` â†’ "äº¤æ˜“æµç¨‹"
   - `<Component>` â†’ "ç®—æ³•ç»„ä»¶"

2. **æå–å±æ€§ä½œä¸ºå…ƒæ•°æ®**
   - æ‰€æœ‰ `DESC`, `NAME`, `ID` å±æ€§ç›´æ¥æå–
   - æ‹¼åœ¨æ–‡æœ¬å¤´éƒ¨

3. **æå–å…³é”®å­èŠ‚ç‚¹**
   - é‡ç‚¹å…³æ³¨å«æœ‰ `class`, `value` (å€¼åƒ Java ç±»å), `script` çš„èŠ‚ç‚¹
   - ä¿ç•™è¿™äº›å¼•ç”¨å…³ç³»

4. **ä¿ç•™é€»è¾‘è¡¨è¾¾å¼**
   - ä¿ç•™ `filter="..."`, `test="..."`, `condition="..."` ç­‰å±æ€§

### 3. æ£€ç´¢ä½“éªŒç¤ºä¾‹

**ç”¨æˆ·è¾“å…¥**ï¼š"æ”¾æ¬¾çš„æ—¶å€™æ˜¯æ€ä¹ˆç®—åˆ©æ¯çš„ï¼Ÿ"

**æ£€ç´¢æµç¨‹**ï¼š
```
ç”¨æˆ·è¾“å…¥
    â†“
BGE å¬å›ç›¸å…³å‘é‡
    â†“
Reranker æ‰¾åˆ° Transaction XML
    â†“ å‘ç°"è´·æ¬¾å‘æ”¾"æµç¨‹å¼•ç”¨äº† CreatePaymentScheduleExecutor
    â†“
Reranker æ‰¾åˆ° Component XML
    â†“ å‘ç° PaymentSchedule å¼•ç”¨äº† DailyCalculatorï¼ˆç­‰é¢æœ¬é‡‘ï¼‰
    â†“
Reranker æ‰¾åˆ° Java Code
    â†“ ç›´æ¥å±•ç¤º DailyCalculator.java çš„æºç 
    â†“
è¿”å›å®Œæ•´çš„è°ƒç”¨é“¾
```

## ğŸ—ï¸ æ–°å¢ Kotlin å®ç°

### æ ¸å¿ƒæ¥å£

```kotlin
/**
 * ä»£ç å‘é‡åŒ–æœåŠ¡
 */
interface CodeVectorizationService {
    suspend fun vectorizeClass(psiClass: PsiClass): VectorFragment
    suspend fun vectorizeMethod(psiMethod: PsiMethod): VectorFragment
    suspend fun vectorizeEnum(psiClass: PsiClass): VectorFragment
    suspend fun vectorizeMyBatisXml(xmlFile: Path): VectorFragment
    suspend fun vectorizeConfigXml(xmlFile: Path): VectorFragment
}

/**
 * XML æ‰å¹³åŒ–å™¨
 */
class XmlFlattener {
    fun flatten(xmlElement: XmlElement): FlattenedXml

    private fun identifyRootType(xmlElement: XmlElement): String
    private fun extractMetadata(xmlElement: XmlElement): Map<String, String>
    private fun extractReferences(xmlElement: XmlElement): List<Reference>
    private fun extractExpressions(xmlElement: XmlElement): List<String>
}
```

### æ•°æ®æ¨¡å‹

```kotlin
// ç±»å‘é‡
data class ClassVector(
    val className: String,
    val signature: String,
    val annotations: List<String>,
    val description: String,
    val fields: List<FieldSummary>,
    val methods: List<MethodSummary>
)

// æ–¹æ³•å‘é‡ï¼ˆåŒ…å«æºç ï¼‰
data class MethodVector(
    val className: String,
    val methodName: String,
    val signature: String,
    val description: String,
    val sourceCode: String  // å®Œæ•´æºç 
)

// æšä¸¾å‘é‡
data class EnumVector(
    val enumName: String,
    val description: String,
    val values: Map<String, String>
)

// XML å‘é‡ï¼ˆé€šç”¨ï¼‰
data class XmlVector(
    val rootType: String,
    val metadata: Map<String, String>,
    val references: List<Reference>,
    val expressions: List<String>
)
```

## ğŸ“Š å‘é‡åŒ–èŒƒå›´æ€»ç»“

| ç±»å‹ | å†…å®¹ | å‘é‡ ID è§„åˆ™ | å†…å­˜å ç”¨ |
|------|------|-------------|---------|
| ç±» | å®šä¹‰ + ä¸šåŠ¡æè¿° + å­—æ®µ + æ–¹æ³•æ‘˜è¦ | `class:{qualifiedName}` | ~2 KB |
| æ–¹æ³• | ä¸Šä¸‹æ–‡ + å®Œæ•´æºç  | `method:{qualifiedName}#{methodName}` | ~5 KB |
| Enum | å®šä¹‰ + å­—å…¸æ˜ å°„ | `enum:{qualifiedName}` | ~1 KB |
| MyBatis XML | SQL æ˜ å°„ + é€»è¾‘ + æ³¨é‡Š | `mybatis:{file}#{id}` | ~1 KB |
| é…ç½® XML | æ‰å¹³åŒ–é…ç½® + å¼•ç”¨å…³ç³» | `config:{file}#{id}` | ~2 KB |
| ä¸šåŠ¡å®ä½“ | è¡¨ç»“æ„ + å­—æ®µ + å…³ç³» | `entity:{tableName}` | ~3 KB |
| æ–‡æ¡£ | Markdown æ–‡æ¡£ | `doc:{file}#{section}` | ~1 KB |

## ğŸ¯ å…³é”®è®¾è®¡ç‚¹

1. **XML é€šç”¨æ‰å¹³åŒ–**ï¼šä¸€å¥—ç­–ç•¥å¤„ç†æ‰€æœ‰ç±»å‹ XML
2. **æ–¹æ³•åŒ…å«æºç **ï¼šæ”¯æŒä»£ç çº§åˆ«çš„æ£€ç´¢
3. **å¼•ç”¨å…³ç³»è¿½è¸ª**ï¼šXML â†’ Java çš„å…³è”
4. **åˆ†çº§ç¼“å­˜**ï¼šçƒ­æ•°æ®å†…å­˜ï¼Œå†·æ•°æ®ç£ç›˜

## ğŸ“ æ›´æ–°çš„æ–‡æ¡£

- âœ… `11_è¯­ä¹‰åŒ–å‘é‡åŒ–.md` å·²æ›´æ–°
  - æ–°å¢ï¼šä»£ç å‘é‡åŒ–ç« èŠ‚ï¼ˆ5 ç§ç±»å‹ï¼‰
  - æ–°å¢ï¼šXML é€šç”¨æ‰å¹³åŒ–ç­–ç•¥
  - æ–°å¢ï¼šæ£€ç´¢ä½“éªŒç¤ºä¾‹
  - æ–°å¢ï¼šKotlin å®ç°æ¥å£
  - æ–°å¢ï¼šæ•°æ®æ¨¡å‹å®šä¹‰

æ‰€æœ‰ä»£ç å‘é‡åŒ–çš„è®¾è®¡å·²å®Œæ•´ï¼ğŸš€
