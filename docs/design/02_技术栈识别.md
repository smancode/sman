# 02 - 技术栈识别

## 目标

为 SmanAgent 项目添加技术栈识别能力，通过分析构建文件（build.gradle/pom.xml）和配置文件（application.yml），自动识别项目使用的技术栈。

## 参考

- knowledge-graph-system 的 `TechStackDetector.java`
- Gradle 和 Maven 配置文件解析规则

## 核心功能

### 1. 构建工具检测

**目标**：识别项目使用的构建工具

**输出**：
- `gradle` - Gradle 构建工具
- `maven` - Maven 构建工具
- `unknown` - 未知构建工具

**检测规则**：
```kotlin
// 优先检查根目录
1. build.gradle / build.gradle.kts / settings.gradle / settings.gradle.kts → gradle
2. pom.xml → maven

// 多模块项目，检查子目录（深度 2）
3. 子目录中的 build.gradle* → gradle
4. 子目录中的 pom.xml → maven
```

### 2. 后端框架检测

**目标**：识别 Web 框架及版本

**输出**：
- 框架名称：`spring-boot`、`spring`、`vert.x` 等
- 框架版本：如 `3.2.0`

**Gradle 检测规则**：
```groovy
// Spring Boot 版本
org.springframework.boot version '3.2.0'

// Spring Boot Starter
implementation 'org.springframework.boot:spring-boot-starter-web'
```

**Maven 检测规则**：
```xml
<!-- Spring Boot Parent -->
<parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>3.2.0</version>
</parent>

<!-- Spring Boot Starter -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>
```

**源码补充检测**：
```kotlin
// 扫描最多 20 个 Java/Kotlin 文件
// 检测 import 语句和注解
import org.springframework.*
@RestController / @Controller → spring-boot
@Service / @Component → spring
```

### 3. JDK 版本检测

**目标**：识别项目的 Java/Kotlin 版本

**输出**：
- JDK 版本：如 `17`、`21`、`11`

**Gradle 检测规则**：
```groovy
// Groovy DSL
sourceCompatibility = 17
targetCompatibility = 17

// Kotlin DSL
java {
    toolchain {
        languageVersion.set(JavaLanguageVersion.of(17))
    }
}
```

**Maven 检测规则**：
```xml
<java.version>17</java.version>
<maven.compiler.source>17</maven.compiler.source>
<maven.compiler.target>17</maven.compiler.target>
```

### 4. 数据库检测

**目标**：识别项目使用的数据库

**输出**：
- 数据库类型：`mysql`、`postgresql`、`h2`、`oracle`

**检测规则**：
```groovy
// Gradle dependencies
runtimeOnly 'com.mysql:mysql-connector-j' → mysql
runtimeOnly 'org.postgresql:postgresql' → postgresql
runtimeOnly 'com.h2database:h2' → h2
runtimeOnly 'com.oracle.database.jdbc:ojdbc11' → oracle
```

### 5. ORM 框架检测

**目标**：识别 ORM 框架

**输出**：
- ORM 框架：`jpa`、`mybatis`、`mybatis-plus`

**检测规则**：
```groovy
// Spring Boot Starters
implementation 'org.springframework.boot:spring-boot-starter-data-jpa' → jpa
implementation 'org.mybatis.spring.boot:mybatis-spring-boot-starter' → mybatis
implementation 'com.baomidou:mybatis-plus-boot-starter' → mybatis-plus
```

### 6. 缓存检测

**目标**：识别缓存中间件

**输出**：
- 缓存类型：`redis`、`memcached`、`caffeine`

**检测规则**：
```groovy
implementation 'org.springframework.boot:spring-boot-starter-data-redis' → redis
implementation 'redis.clients:jedis' → redis
implementation 'io.lettuce:lettuce-core' → redis
```

### 7. 消息队列检测

**目标**：识别消息队列中间件

**输出**：
- MQ 类型：`kafka`、`rocketmq`、`rabbitmq`

**检测规则**：
```groovy
implementation 'org.springframework.kafka:spring-kafka' → kafka
implementation 'org.apache.rocketmq:rocketmq-spring-boot-starter' → rocketmq
implementation 'org.springframework.boot:spring-boot-starter-amqp' → rabbitmq
```

### 8. 日志框架检测

**目标**：识别日志框架

**输出**：
- 日志框架：`logback`、`log4j2`、`jul`

**Gradle 检测规则**：
```groovy
implementation 'ch.qos.logback:logback-classic' → logback
implementation 'org.apache.logging.log4j:log4j-slf4j-impl' → log4j2
implementation 'org.apache.logging.log4j:log4j-core' → log4j2
```

**源码补充检测**：
```kotlin
import org.slf4j.* → slf4j
import ch.qos.logback.* → logback
import org.apache.logging.log4j.* → log4j2
java.util.logging → jul
```

### 9. JSON 库检测

**目标**：识别 JSON 序列化库

**输出**：
- JSON 库：`jackson`、`fastjson`、`gson`

**检测规则**：
```groovy
implementation 'com.fasterxml.jackson.core:jackson-databind' → jackson
implementation 'com.alibaba.fastjson2:fastjson2' → fastjson
implementation 'com.google.code.gson:gson' → gson
```

**源码补充检测**：
```kotlin
import com.fasterxml.jackson.* → jackson
import com.alibaba.fastjson.* → fastjson
import com.google.gson.* → gson
```

### 10. Lombok 检测

**目标**：检测是否使用 Lombok

**输出**：
- 是否使用：`true` / `false`
- Lombok 版本：如 `1.18.30`

**检测规则**：
```groovy
// Gradle
annotationProcessor 'org.projectlombok:lombok:1.18.30'
compileOnly 'org.projectlombok:lombok'

// Maven
<dependency>
    <groupId>org.projectlombok</groupId>
    <artifactId>lombok</artifactId>
    <version>1.18.30</version>
    <scope>provided</scope>
</dependency>
```

**源码补充检测**：
```kotlin
// 扫描最多 20 个文件，检测注解
@Data / @Builder / @Getter / @Setter / @Slf4j / @RequiredArgsConstructor
→ Lombok enabled
```

### 11. 认证与授权检测

**目标**：识别认证授权框架

**输出**：
- 认证框架：`spring-security`、`shiro`、`jwt`

**检测规则**：
```groovy
implementation 'org.springframework.boot:spring-boot-starter-security' → spring-security
implementation 'org.apache.shiro:shiro-spring-boot-starter' → shiro
implementation 'io.jsonwebtoken:jjwt-api' → jwt
```

### 12. 测试框架检测

**目标**：识别测试框架

**输出**：
- 测试框架：`junit5`、`testng`、`mockito`

**检测规则**：
```groovy
testImplementation 'org.junit.jupiter:junit-jupiter' → junit5
testImplementation 'org.testng:testng' → testng
testImplementation 'org.mockito:mockito-core' → mockito
```

## Kotlin 实现

### 文件位置

```
src/main/kotlin/com/smancode/smanagent/analyzer/
├── TechStackDetector.kt              # 主检测器
├── parser/
│   ├── GradleParser.kt              # Gradle 文件解析
│   ├── MavenParser.kt               # Maven 文件解析
│   └── YamlParser.kt                # YAML 文件解析
└── model/
    └── TechStack.kt                 # 技术栈数据模型
```

### 核心接口

```kotlin
interface TechStackDetector {
    /**
     * 检测技术栈
     * @param projectPath 项目路径
     * @return 技术栈信息
     */
    fun detect(projectPath: Path): TechStack
}

data class TechStack(
    val buildTool: BuildTool,
    val jdkVersion: String?,
    val webFramework: String?,
    val webFrameworkVersion: String?,
    val database: String?,
    val ormFramework: String?,
    val cacheFramework: String?,
    val messageQueue: String?,
    val loggingFramework: String?,
    val jsonLibrary: String?,
    val useLombok: Boolean?,
    val authFramework: String?,
    val testFramework: String?
)

enum class BuildTool {
    GRADLE,
    MAVEN,
    UNKNOWN
}
```

## 与 knowledge-graph-system 的差异

### 可以借鉴的部分

1. **多源检测策略**
   - 构建文件 → 配置文件 → 源码
   - 逐步补充缺失信息

2. **正则表达式提取版本号**
   - 从复杂的依赖声明中提取版本

3. **源码补充检测**
   - 当构建文件不完整时，从源码 import 语句推断

### 需要调整的部分

1. **Kotlin 语言适配**
   - Kotlin 项目的检测规则
   - `build.gradle.kts` 的解析

2. **IntelliJ PSI 集成**
   - 利用 PSI 获取依赖信息，无需解析文件

3. **多模块项目处理**
   - 合并多个子模块的技术栈信息
   - 处理模块间的依赖冲突

## 专家知识库

### 关键问题

1. **如何处理多模块项目？**
   - 策略1：只分析根模块的构建文件
   - 策略2：合并所有子模块的技术栈
   - 建议：策略2，更全面

2. **如何处理版本冲突？**
   - 同一依赖不同版本：选择最高版本
   - 传递依赖的版本：记录但不计入技术栈

3. **如何提高检测准确率？**
   - 多源检测：构建文件 + 配置文件 + 源码
   - 互相验证：构建文件的依赖在源码中是否被使用

4. **Gradle Kotlin DSL 的特殊性**
   - 语法不同：`implementation("group:name:version")`
   - 需要专门的正则表达式

## 待解决的问题

1. **增量更新**
   - 依赖版本变化时，如何增量更新？
   - 文件修改时间检测？

2. **性能优化**
   - 大型项目依赖数量多，如何优化解析速度？
   - 是否需要缓存解析结果？

3. **错误处理**
   - 构建文件格式错误？
   - 版本号提取失败？

4. **扩展性**
   - 如何添加新的技术栈检测规则？
   - 是否需要配置化的规则引擎？

## 下一步

- [x] 实现基础的构建工具检测
- [x] 实现常见技术栈的识别规则
- [x] 集成 PSI 获取依赖信息
- [x] 编写单元测试
- [x] 设计存储格式（向量库 Schema）

---

## ✅ 实现完成 (2026-01-30)

### 实现文件

- **位置**: `src/main/kotlin/com/smancode/smanagent/analysis/techstack/TechStackDetector.kt`
- **测试**: 所有测试通过 (196 tests passed)

### 实现功能

1. ✅ **构建工具检测** - Maven/Gradle 识别
2. ✅ **框架识别** - Spring Boot、Ktor、Vert.x 等
3. ✅ **编程语言检测** - Kotlin、Java、Groovy
4. ✅ **数据库识别** - MySQL、PostgreSQL、MongoDB、Redis 等
5. ✅ **缓存识别** - Redis、Caffeine、Ehcache

### 核心数据类

```kotlin
@Serializable
data class TechStack(
    val buildType: BuildType,
    val frameworks: List<FrameworkInfo>,
    val languages: List<LanguageInfo>,
    val databases: List<DatabaseInfo>
)

@Serializable
data class FrameworkInfo(
    val name: String,
    val version: String?,
    val category: FrameworkCategory
)

enum class FrameworkCategory {
    WEB_FRAMEWORK, ORM, CACHE, MQ,
    LOGGING, AUTH, TESTING, OTHER
}
```

### 验证状态

```bash
./gradlew test
# BUILD SUCCESSFUL - 196 tests completed
```
