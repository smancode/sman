# 01 - 整体架构设计

## 1. 架构全景图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           SmanAgent 完整架构                                 │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              前台层 (Foreground)                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                │
│    │   SmanLoop   │───▶│PromptDispatch│───▶│  LLM Service │                │
│    │  (ReAct 循环) │    │    er        │    │              │                │
│    └──────┬───────┘    └──────────────┘    └──────────────┘                │
│           │                                                                 │
│           ▼                                                                 │
│    ┌──────────────┐    ┌──────────────┐                                    │
│    │SubTaskExecutor│───▶│ToolRegistry  │                                    │
│    │ (上下文隔离)  │    │  (工具注册)   │                                    │
│    └──────────────┘    └──────────────┘                                    │
│                                                                             │
│    关键能力:                                                                 │
│    - 处理用户消息                                                           │
│    - 调用工具探索代码                                                        │
│    - 加载后台学习成果 (expert_consult)                                       │
│    - 生成回复                                                               │
│                                                                             │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                │ 读写共享记忆
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           记忆层 (Memory Layer)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                     SharedMemoryManager (核心)                       │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                     │   │
│  │   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │   │
│  │   │SessionMemory │  │ProjectMemory │  │ GlobalMemory │            │   │
│  │   │  (会话级)    │  │  (项目级)    │  │  (全局级)    │            │   │
│  │   │              │  │              │  │              │            │   │
│  │   │ • 对话历史   │  │ • 领域知识   │  │ • 最佳实践   │            │   │
│  │   │ • 工具调用   │  │ • 学习记录   │  │ • 跨项目模式 │            │   │
│  │   │ • 当前上下文 │  │ • 失败记录   │  │ • 通用技能   │            │   │
│  │   │              │  │ • 代码模式   │  │              │            │   │
│  │   └──────────────┘  └──────────────┘  └──────────────┘            │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                     MemoryStorage (持久化)                           │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                     │   │
│  │   ┌────────────────┐  ┌────────────────┐  ┌────────────────┐      │   │
│  │   │   JSON 文件     │  │   H2 数据库    │  │   向量索引     │      │   │
│  │   │                │  │                │  │                │      │   │
│  │   │ project_map    │  │ learning_      │  │ BGE-M3         │      │   │
│  │   │ learning_cache │  │   records      │  │ embeddings     │      │   │
│  │   │ failure_log    │  │ code_vectors   │  │                │      │   │
│  │   └────────────────┘  └────────────────┘  └────────────────┘      │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  关键能力:                                                                   │
│  - 前后台共享读写                                                           │
│  - 向量语义检索 (BGE-M3)                                                    │
│  - 持久化存储 (JSON + H2)                                                   │
│  - 缓存加速 (LRU Cache)                                                     │
│                                                                             │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                │ 读写共享记忆
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         后台层 (Background Layer)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                   SelfEvolutionLoop (主循环)                         │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                     │   │
│  │   while (enabled) {                                                 │   │
│  │       1. 检查用户打断                                                │   │
│  │       2. 加载项目记忆                                                │   │
│  │       3. 生成好问题 (QuestionGenerator)                              │   │
│  │       4. 死循环检测 (DoomLoopGuard)                                  │   │
│  │       5. 探索学习 (ToolExplorer)                                     │   │
│  │       6. 总结并记录 (LearningRecorder)                               │   │
│  │       7. 更新共享记忆                                                │   │
│  │       delay(intervalMs)                                             │   │
│  │   }                                                                 │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        后台子组件                                    │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                     │   │
│  │   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │   │
│  │   │QuestionGener │  │ToolExplorer  │  │LearningRecor │            │   │
│  │   │    ator      │  │  (探索器)    │  │  derService  │            │   │
│  │   │ (问题生成)   │  │              │  │ (学习记录)   │            │   │
│  │   └──────────────┘  └──────────────┘  └──────────────┘            │   │
│  │                                                                     │   │
│  │   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │   │
│  │   │DoomLoopGuard │  │FailureRecove │  │BackoffStrate │            │   │
│  │   │ (死循环防护) │  │  ryService   │  │  gy          │            │   │
│  │   │              │  │ (失败恢复)   │  │ (退避策略)   │            │   │
│  │   └──────────────┘  └──────────────┘  └──────────────┘            │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  关键能力:                                                                   │
│  - 自主生成问题                                                             │
│  - 工具探索学习                                                             │
│  - 知识提炼存储                                                             │
│  - 死循环防护                                                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                │
                                │ 资源调用
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           资源层 (Resource Layer)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│   │   LLM API    │  │   BGE-M3     │  │ BGE-Reranker │  │  本地文件    │  │
│   │  (推理生成)  │  │  (向量化)    │  │  (重排序)    │  │  (JSON/日志) │  │
│   └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘  │
│                                                                             │
│   ┌──────────────┐  ┌──────────────┐                                       │
│   │VectorStore   │  │H2 Database   │                                       │
│   │  Manager     │  │  (持久化)    │                                       │
│   └──────────────┘  └──────────────┘                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 2. 组件职责清单

### 2.1 前台层组件

| 组件 | 职责 | 输入 | 输出 |
|------|------|------|------|
| **SmanLoop** | ReAct 循环，处理用户消息 | 用户消息 | 回复消息 |
| **SubTaskExecutor** | 工具调用，上下文隔离 | ToolPart | 工具结果 |
| **ToolRegistry** | 工具注册和查找 | 工具名 | Tool 实例 |
| **PromptDispatcher** | 提示词构建 | Session | System/User Prompt |

### 2.2 记忆层组件

| 组件 | 职责 | 输入 | 输出 |
|------|------|------|------|
| **SharedMemoryManager** | 统一记忆管理入口 | 查询请求 | 记忆数据 |
| **SessionMemory** | 会话级临时记忆 | sessionId | 会话上下文 |
| **ProjectMemory** | 项目级持久记忆 | projectKey | 项目知识 |
| **GlobalMemory** | 全局级跨项目记忆 | - | 通用知识 |
| **MemoryStorage** | 持久化存储 | 写入/读取请求 | 存储结果 |

### 2.3 后台层组件

| 组件 | 职责 | 输入 | 输出 |
|------|------|------|------|
| **SelfEvolutionLoop** | 后台主循环 | 项目配置 | 学习记录 |
| **QuestionGenerator** | 生成好问题 | 项目记忆 | 问题列表 |
| **ToolExplorer** | 执行工具探索 | 问题 | 探索结果 |
| **LearningRecorder** | 记录学习成果 | 探索结果 | 持久化记录 |
| **DoomLoopGuard** | 死循环检测 | 工具调用历史 | 检测结果 |
| **FailureRecoveryService** | 失败恢复 | 失败记录 | 重试结果 |
| **BackoffStrategy** | 退避策略 | 错误次数 | 退避时间 |

### 2.4 资源层组件

| 组件 | 职责 | 特点 |
|------|------|------|
| **LLM API** | 推理、生成、理解 | 按需调用 |
| **BGE-M3** | 文本向量化 | 1024 维向量 |
| **BGE-Reranker** | 相关性重排序 | 提升召回精度 |
| **VectorStoreManager** | 向量存储单例 | H2 + 内存缓存 |
| **H2 Database** | 关系型持久化 | 嵌入式数据库 |
| **本地文件** | JSON/日志存储 | 文件系统 |

## 3. 数据流向

### 3.1 前台数据流（用户请求 → 回复）

```
用户请求: "增加先本后息的还款方式"
                    │
                    ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 1: 接收用户消息                                          │
│         SmanChatPanel.sendMessage()                          │
└───────────────────────────┬───────────────────────────────────┘
                            │
                            ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 2: 加载项目上下文                                        │
│         SharedMemoryManager.getProjectMemory()                │
│                                                               │
│         获取:                                                 │
│         • 技术栈信息                                          │
│         • 已知的学习记录索引                                  │
│         • 代码模式                                            │
└───────────────────────────┬───────────────────────────────────┘
                            │
                            ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 3: 语义搜索相关学习成果                                  │
│         expert_consult 工具调用                               │
│                                                               │
│         搜索:                                                 │
│         • "还款方式" 相关的学习记录                           │
│         • "还款" 相关的代码片段                               │
│         • "先本后息" 相关的业务知识                           │
│                                                               │
│         返回:                                                 │
│         • RepaymentService 处理还款逻辑                       │
│         • RepaymentType 枚举定义还款方式                      │
│         • RepaymentCalculator 计算还款金额                    │
└───────────────────────────┬───────────────────────────────────┘
                            │
                            ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 4: SmanLoop ReAct 循环                                   │
│                                                               │
│         Round 1: 理解需求                                     │
│           → 知道要增加新的还款方式枚举值                       │
│           → 知道要修改计算逻辑                                │
│                                                               │
│         Round 2: 定位代码                                     │
│           → read_file(RepaymentType.java)                    │
│           → read_file(RepaymentCalculator.java)              │
│                                                               │
│         Round 3: 设计方案                                     │
│           → 生成代码修改方案                                  │
│                                                               │
│         Round 4: 应用修改                                     │
│           → apply_change(...)                                 │
└───────────────────────────┬───────────────────────────────────┘
                            │
                            ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 5: 返回结果给用户                                        │
│         • 修改了哪些文件                                      │
│         • 增加了什么逻辑                                      │
│         • 测试建议                                            │
└───────────────────────────────────────────────────────────────┘
```

### 3.2 后台数据流（自问自答 → 学习记录）

```
┌───────────────────────────────────────────────────────────────┐
│ SelfEvolutionLoop 主循环                                      │
└───────────────────────────┬───────────────────────────────────┘
                            │
                            ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 1: 加载项目记忆                                          │
│         SharedMemoryManager.getProjectMemory()                │
│                                                               │
│         获取:                                                 │
│         • 已有的领域知识                                      │
│         • 知识盲点列表                                        │
│         • 上次探索的位置                                      │
└───────────────────────────┬───────────────────────────────────┘
                            │
                            ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 2: 生成好问题 (QuestionGenerator + LLM)                  │
│                                                               │
│         输入给 LLM:                                           │
│         • 项目结构信息                                        │
│         • 已知的知识                                          │
│         • 知识盲点                                            │
│                                                               │
│         LLM 输出:                                             │
│         • Q1: "还款模块的核心流程是什么？"                     │
│         • Q2: "还款方式有哪些类型，如何区分？"                 │
│         • Q3: "还款计算涉及哪些数据库表？"                     │
└───────────────────────────┬───────────────────────────────────┘
                            │
                            ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 3: 死循环检测 (DoomLoopGuard)                            │
│                                                               │
│         检查:                                                 │
│         • 这个问题是否已探索过？(向量相似度)                   │
│         • 最近是否有重复的工具调用？                          │
│         • 是否在退避期内？                                    │
│                                                               │
│         结果: 通过 → 继续                                     │
│               不通过 → 退避或跳过                              │
└───────────────────────────┬───────────────────────────────────┘
                            │
                            ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 4: 工具探索 (ToolExplorer)                               │
│                                                               │
│         for each question:                                    │
│           1. expert_consult("还款") → 找到相关代码            │
│           2. read_file(RepaymentService.java) → 读取内容      │
│           3. call_chain(RepaymentService.repay) → 理解调用    │
│           4. grep_file("repayment_") → 找相关表               │
└───────────────────────────┬───────────────────────────────────┘
                            │
                            ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 5: LLM 总结学习成果                                      │
│                                                               │
│         输入给 LLM:                                           │
│         • 问题: "还款模块的核心流程是什么？"                   │
│         • 探索过程: 工具调用历史和结果                         │
│                                                               │
│         LLM 输出:                                             │
│         • 答案: 还款流程包括申请→审批→放款→还款→结清           │
│         • 涉及文件: [RepaymentService.java, ...]              │
│         • 置信度: 0.95                                        │
│         • 关键发现: ...                                       │
└───────────────────────────┬───────────────────────────────────┘
                            │
                            ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 6: 向量化并持久化 (LearningRecorder)                     │
│                                                               │
│         1. BGE-M3 向量化答案                                  │
│         2. 写入 H2 (learning_records 表)                      │
│         3. 写入向量索引                                       │
│         4. 更新 project_map.json                              │
└───────────────────────────┬───────────────────────────────────┘
                            │
                            ▼
┌───────────────────────────────────────────────────────────────┐
│ Step 7: 更新项目记忆                                          │
│                                                               │
│         • 添加到领域知识列表                                  │
│         • 更新知识盲点                                        │
│         • 记录探索历史                                        │
└───────────────────────────────────────────────────────────────┘
```

## 4. 关键设计决策

### 4.1 为什么是双循环而不是单循环？

| 对比维度 | 单循环 | 双循环 |
|---------|--------|--------|
| 用户响应速度 | 慢（要等后台学习） | **快（前台独立）** |
| 学习连续性 | 差（被用户请求打断） | **好（后台持续）** |
| 资源竞争 | 高 | **低（隔离）** |
| 复杂度 | 低 | 中 |
| 可靠性 | 低（一处失败全部失败） | **高（隔离故障）** |

### 4.2 为什么用向量检索而非关键词匹配？

| 对比维度 | 关键词匹配 | 向量语义检索 |
|---------|-----------|-------------|
| 召回精度 | 低 | **高** |
| 同义词理解 | 不支持 | **支持** |
| 上下文理解 | 不支持 | **支持** |
| 计算成本 | 低 | 中（BGE-M3 足够快） |

### 4.3 为什么用 JSON + H2 双存储？

| 存储类型 | 用途 | 理由 |
|---------|------|------|
| **JSON 文件** | project_map, 配置 | 人类可读、版本控制友好 |
| **H2 数据库** | 学习记录、向量索引 | 查询高效、支持复杂查询 |

## 5. 扩展点

### 5.1 未来可扩展

1. **全局记忆共享**：多个项目的通用知识共享
2. **学习记录导出**：导出为文档供团队学习
3. **主动推荐**：后台学习后主动推荐给用户
4. **学习效果评估**：评估学习成果的实际使用率

### 5.2 插件化设计

- QuestionGenerator: 可插拔的问题生成策略
- ToolExplorer: 可插拔的探索策略
- BackoffStrategy: 可插拔的退避策略
