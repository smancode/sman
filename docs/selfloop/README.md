# 自迭代智能体设计文档

## 概述

SmanAgent 自迭代智能体是一个**后台自我进化 + 前台用户服务**的双循环架构。

### 核心理念

1. **AI 驱动**：所有决策由 LLM 做出，不硬编码流程
2. **目标导向**：只定义目标，让 AI 自己找路径
3. **自问自答**：AI 自己提出好问题，自己探索，自己学习
4. **价值落地**：学习成果必须能被前台用户需求使用

### 可用资源

| 资源 | 能力 | 使用场景 |
|------|------|---------|
| **LLM** | 推理、生成、理解 | 自问自答、代码理解、问题生成 |
| **BGE-M3** | 向量化 | 语义搜索、知识检索 |
| **BGE-Reranker** | 重排序 | 精准召回、相关性提升 |
| **本地文件** | 持久化 | 记忆存储、日志、配置 |
| **H2 数据库** | 向量存储 | 向量检索、元数据存储 |

## 文档目录

```
docs/selfloop/
├── README.md                    # 本文档
├── 01-architecture.md          # 整体架构设计
├── 02-memory-system.md         # 记忆系统设计
├── 03-backend-loop.md          # 后台自迭代循环
├── 04-frontend-integration.md  # 前台集成与资源加载
├── 05-doom-loop-guard.md       # 死循环防护机制
├── 06-implementation-plan.md   # 实现计划与任务拆分
└── examples/                   # 示例与场景
    ├── example-user-request.md # 用户需求处理示例
    └── example-self-learning.md# 自学习流程示例
```

## 快速理解

### 双循环架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      SmanAgent 双循环                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   前台循环（用户驱动）          后台循环（自我进化）              │
│   ┌─────────────────┐          ┌─────────────────┐              │
│   │   用户消息       │          │  while(true)    │              │
│   │       ↓         │          │  自问自答       │              │
│   │   SmanLoop      │          │  探索学习       │              │
│   │       ↓         │          │  更新记忆       │              │
│   │   回复用户       │          └────────┬────────┘              │
│   └────────┬────────┘                   │                       │
│            │                            │                       │
│            └────────────┬───────────────┘                       │
│                         ▼                                       │
│              ┌─────────────────────┐                            │
│              │    共享记忆系统      │                            │
│              │  (学习成果落地存储)  │                            │
│              └─────────────────────┘                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 核心价值：学习成果可用

```
用户需求: "增加先本后息的还款方式"
                    │
                    ▼
    ┌───────────────────────────────────────┐
    │  加载相关学习成果                       │
    │                                       │
    │  后台已学到的知识:                      │
    │  - 还款模块在 RepaymentService         │
    │  - 还款方式枚举在 RepaymentType        │
    │  - 还款计算逻辑在 RepaymentCalculator  │
    │  - 相关的数据库表: repayment_schedule  │
    └───────────────────────────────────────┘
                    │
                    ▼
    ┌───────────────────────────────────────┐
    │  SmanLoop 处理用户需求                 │
    │                                       │
    │  有了上下文，精准定位代码位置           │
    │  准确理解业务逻辑                       │
    │  快速给出修改方案                       │
    └───────────────────────────────────────┘
```

## 设计原则

1. **学习是为了使用**：后台学习的每一条知识，都要能被前台查询和使用
2. **语义检索优先**：通过向量搜索找到相关学习成果，而非硬编码规则
3. **分层记忆**：会话级、项目级、全局级三层记忆，按需加载
4. **增量学习**：每次学习都是增量，不重复，不遗漏
5. **底线思维**：死循环防护是核心，记录一切失败

## 状态

- [x] 初步架构设计
- [x] 详细设计文档 (01-06)
- [x] 示例文档
- [ ] 代码实现

## 阅读顺序

1. **README.md** - 了解整体概念
2. **01-architecture.md** - 理解架构设计
3. **02-memory-system.md** - 理解记忆系统（核心）
4. **03-backend-loop.md** - 理解后台自迭代
5. **04-frontend-integration.md** - 理解前台资源加载
6. **05-doom-loop-guard.md** - 理解死循环防护
7. **06-implementation-plan.md** - 开始实现
8. **examples/** - 参考具体示例
