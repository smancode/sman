# å¤šè½®å¯¹è¯å®ç°æ–‡æ¡£ (Final - --resume æ–¹æ¡ˆ)

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0 (Final)
**åˆ›å»ºæ—¥æœŸ**: 2026-01-05
**æœ€åæ›´æ–°**: 2026-01-05
**ä½œè€…**: SiliconMan Team
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#1-æ¦‚è¿°)
2. [æ–¹æ¡ˆæ¼”è¿›å†å²](#2-æ–¹æ¡ˆæ¼”è¿›å†å²)
3. [æœ€ç»ˆæ–¹æ¡ˆæ¶æ„](#3-æœ€ç»ˆæ–¹æ¡ˆæ¶æ„)
4. [æ ¸å¿ƒå®ç°](#4-æ ¸å¿ƒå®ç°)
5. [é€šä¿¡æµç¨‹](#5-é€šä¿¡æµç¨‹)
6. [ä¼šè¯æ–‡ä»¶ç»“æ„](#6-ä¼šè¯æ–‡ä»¶ç»“æ„)
7. [æµ‹è¯•æ–¹æ³•](#7-æµ‹è¯•æ–¹æ³•)
8. [å…³é”®å‚æ•°è¯´æ˜](#8-å…³é”®å‚æ•°è¯´æ˜)
9. [ä¼šè¯ç”Ÿå‘½å‘¨æœŸ](#9-ä¼šè¯ç”Ÿå‘½å‘¨æœŸ)
10. [æ•…éšœæ’æŸ¥](#10-æ•…éšœæ’æŸ¥)

---

## 1. æ¦‚è¿°

### 1.1 åŠŸèƒ½è¯´æ˜

**å¤šè½®å¯¹è¯**ï¼šå…è®¸ Claude Code è®°ä½ä¹‹å‰å¯¹è¯çš„å†…å®¹ï¼Œå®ç°ä¸Šä¸‹æ–‡è®°å¿†ã€‚

**ä½¿ç”¨åœºæ™¯**ï¼š
```bash
# ç¬¬1è½®
ç”¨æˆ·: "è®°ä½ï¼šæˆ‘æœ€å–œæ¬¢çš„é¢œè‰²æ˜¯è“è‰²"
Claude: "å¥½çš„ï¼Œæˆ‘è®°ä½äº†ã€‚"

# ç¬¬2è½®ï¼ˆä½¿ç”¨ç›¸åŒçš„ sessionIdï¼‰
ç”¨æˆ·: "æˆ‘æœ€å–œæ¬¢çš„é¢œè‰²æ˜¯ä»€ä¹ˆï¼Ÿ"
Claude: "æ ¹æ®æˆ‘ä»¬ä¹‹å‰çš„å¯¹è¯ï¼Œä½ æœ€å–œæ¬¢çš„é¢œè‰²æ˜¯è“è‰²ã€‚"  # â† è®°ä½äº†ï¼
```

### 1.2 å®ç°åŸç† (Final)

**æ ¸å¿ƒæ€æƒ³**ï¼šåˆ©ç”¨ Claude Code CLI çš„ `--resume` å‚æ•° + ä¼šè¯æ–‡ä»¶æŒä¹…åŒ–ã€‚

| ç»„ä»¶ | ä½œç”¨ |
|------|------|
| **sessionId** | ä¼šè¯çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆUUID æ ¼å¼ï¼‰ |
| **ä¼šè¯æ–‡ä»¶** | å­˜å‚¨å¯¹è¯å†å²ï¼ˆ`~/.claude/projects/.../<sessionId>.jsonl`ï¼‰ |
| **`--session-id` å‚æ•°** | ç¬¬ä¸€æ¬¡è¯·æ±‚æ—¶åˆ›å»ºæ–°ä¼šè¯ |
| **`--resume` å‚æ•°** | åç»­è¯·æ±‚æ—¶æ¢å¤ä¼šè¯ï¼ˆåŠ è½½å†å²ï¼‰ |
| **æŒ‰éœ€åˆ›å»ºè¿›ç¨‹** | æ¯æ¬¡è¯·æ±‚åˆ›å»ºç‹¬ç«‹ Workerï¼Œæ‰§è¡Œå®Œè‡ªåŠ¨é€€å‡º |

---

## 2. æ–¹æ¡ˆæ¼”è¿›å†å²

### 2.1 å››ä¸ªé˜¶æ®µçš„æ¢ç´¢

| é˜¶æ®µ | æ–¹æ¡ˆ | æ ¸å¿ƒè®¾è®¡ | é—®é¢˜ | ç»“æœ |
|------|------|---------|------|------|
| **é˜¶æ®µ1** | å…±äº«è¿›ç¨‹æ±  + `--session-id` | å¤šä¸ªè¯·æ±‚å…±äº«Workerè¿›ç¨‹æ±  | Workerè¿›ç¨‹é€€å‡º,sessionIdè¢«CLIé”å®š | âŒ å¤±è´¥ |
| **é˜¶æ®µ2** | SessionRouter (ä¼šè¯è·¯ç”±) | sessionIdâ†’workerIdæ˜ å°„ç»‘å®š | Workerè¿›ç¨‹é‡å¯å¯¼è‡´CLIå†…éƒ¨é”å†²çª | âŒ å¤±è´¥ |
| **é˜¶æ®µ3** | DedicatedWorkerPool (ä¸“å±è¿›ç¨‹) | ä¸ºæ¯ä¸ªsessionåˆ›å»ºç‹¬ç«‹Worker | èµ„æºæ¶ˆè€—å¤§,å®ç°å¤æ‚ | âš ï¸ å¯ç”¨ä½†è¿‡åº¦è®¾è®¡ |
| **é˜¶æ®µ4** | `--resume` æŒ‰éœ€åˆ›å»º | æ£€æµ‹ä¼šè¯æ–‡ä»¶,æ™ºèƒ½é€‰æ‹©å‚æ•° | **å®Œç¾è§£å†³!** | âœ… **æˆåŠŸ** |

### 2.2 ä¸ºä»€ä¹ˆå‰3ä¸ªæ–¹æ¡ˆå¤±è´¥ï¼Ÿ

#### é—®é¢˜1: Workerè¿›ç¨‹é€€å‡ºå¯¼è‡´sessionIdé”å®š

**ç°è±¡**ï¼š
```
ç¬¬1è½®: worker-abc123 åˆ›å»ºä¼šè¯,è¿›ç¨‹é€€å‡º
ç¬¬2è½®: worker-def456 å°è¯•ä½¿ç”¨åŒä¸€sessionId
é”™è¯¯: "Session ID is already in use."
```

**æ ¹å› **ï¼š
- Claude Code CLIå†…éƒ¨æœ‰ä¼šè¯é”æœºåˆ¶
- å³ä½¿Workerè¿›ç¨‹é€€å‡º,sessionIdä»ç„¶è¢«"é”å®š"
- ä¸åŒè¿›ç¨‹æ— æ³•ä½¿ç”¨åŒä¸€sessionId

#### é—®é¢˜2: SessionRouteræ— æ³•è§£å†³é”å®šé—®é¢˜

**è®¾è®¡**ï¼š
```java
// SessionRouter: ç¡®ä¿åŒä¸€sessionIdä½¿ç”¨åŒä¸€worker
public ClaudeCodeWorker acquireWorker(String sessionId) {
    String workerId = sessionToWorker.get(sessionId);
    if (workerId != null) {
        return processPool.getWorker(workerId);  // è¿”å›åŒä¸€worker
    }
    // ...
}
```

**é—®é¢˜**ï¼š
- Workerè¿›ç¨‹åœ¨æ¯æ¬¡è¯·æ±‚åä»ç„¶é€€å‡º
- SessionRouteråªèƒ½ç¡®ä¿è·¯ç”±åˆ°åŒä¸€ä¸ªworkerId
- ä½†workerè¿›ç¨‹é€€å‡ºå,sessionIdä»ç„¶è¢«é”å®š

### 2.3 æœ€ç»ˆæ–¹æ¡ˆçš„çªç ´æ€§æ€è·¯

**æ ¸å¿ƒåˆ›æ–°**ï¼šä¸å†å°è¯•ä¿æŒWorkerè¿›ç¨‹è¿è¡Œ,è€Œæ˜¯**åˆ©ç”¨CLIçš„ä¼šè¯æ¢å¤æœºåˆ¶**

```
ç¬¬1è½®:
åˆ›å»ºWorker â†’ ä½¿ç”¨ --session-id åˆ›å»ºæ–°ä¼šè¯
         â†’ Workeræ‰§è¡Œå®Œè¯·æ±‚åé€€å‡º
         â†’ âœ… ä¼šè¯æ–‡ä»¶å·²ä¿å­˜

ç¬¬2è½®:
åˆ›å»ºæ–°Worker â†’ æ£€æµ‹åˆ°ä¼šè¯æ–‡ä»¶å­˜åœ¨
            â†’ ä½¿ç”¨ --resume æ¢å¤ä¼šè¯
            â†’ CLIè‡ªåŠ¨åŠ è½½å†å²æ¶ˆæ¯
            â†’ Workeræ‰§è¡Œå®Œè¯·æ±‚åé€€å‡º
            â†’ âœ… è®°ä½äº†ç¬¬1è½®çš„å†…å®¹!
```

**å…³é”®ä¼˜åŠ¿**ï¼š
- âœ… ä¸éœ€è¦ä¿æŒWorkerè¿›ç¨‹è¿è¡Œ
- âœ… æ¯æ¬¡è¯·æ±‚éƒ½æ˜¯ç‹¬ç«‹è¿›ç¨‹,æ— é”å®šé—®é¢˜
- âœ… CLIè‡ªåŠ¨ç®¡ç†ä¼šè¯æ–‡ä»¶
- âœ… ç®€å•ã€å¯é ã€èµ„æºé«˜æ•ˆ

---

## 3. æœ€ç»ˆæ–¹æ¡ˆæ¶æ„

### 3.1 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å‰ç«¯ (IDE Plugin)                        â”‚
â”‚  - ç”ŸæˆUUIDä½œä¸ºsessionId                                      â”‚
â”‚  - å‘é€HTTP POSTè¯·æ±‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ POST /api/analysis/chat
                         â”‚ {sessionId, message, projectKey}
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              QuickAnalysisController                         â”‚
â”‚  - æ¥æ”¶è¯·æ±‚å‚æ•°                                                â”‚
â”‚  - è°ƒç”¨ processPool.createWorker(sessionId)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ClaudeCodeProcessPool.createWorker()               â”‚
â”‚  - æ£€æŸ¥ä¼šè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨                                        â”‚
â”‚  - å¦‚æœå­˜åœ¨: ä½¿ç”¨ --resume                                    â”‚
â”‚  - å¦‚æœä¸å­˜åœ¨: ä½¿ç”¨ --session-id                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Claude Code CLI è¿›ç¨‹ (ç‹¬ç«‹è¿›ç¨‹)                    â”‚
â”‚  - ç¬¬1æ¬¡: ä½¿ç”¨ --session-id åˆ›å»ºä¼šè¯                           â”‚
â”‚  - ç¬¬2æ¬¡+: ä½¿ç”¨ --resume æ¢å¤ä¼šè¯                              â”‚
â”‚  - åŠ è½½ä¼šè¯æ–‡ä»¶ä¸­çš„å†å²æ¶ˆæ¯                                    â”‚
â”‚  - æ‰§è¡ŒAIæ¨ç†                                                  â”‚
â”‚  - è°ƒç”¨åç«¯HTTP APIå·¥å…·                                        â”‚
â”‚  - è¿”å›ç»“æœ                                                    â”‚
â”‚  - è¿›ç¨‹è‡ªç„¶é€€å‡º                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ä¼šè¯æ–‡ä»¶ (~/.claude/projects/)                   â”‚
â”‚  - è‡ªåŠ¨ä¿å­˜å¯¹è¯å†å²                                            â”‚
â”‚  - JSONLæ ¼å¼,æ¯è¡Œä¸€æ¡æ¶ˆæ¯                                      â”‚
â”‚  - é€šè¿‡parentUuidå½¢æˆæ¶ˆæ¯é“¾                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 å¹¶å‘æ§åˆ¶

**ä½¿ç”¨ Semaphore é™åˆ¶åŒæ—¶è¿è¡Œçš„è¿›ç¨‹æ•°**ï¼š

```java
@Component
public class ClaudeCodeProcessPool {
    private Semaphore concurrencySemaphore;  // å¹¶å‘æ§åˆ¶ä¿¡å·é‡

    public ClaudeCodeWorker createWorker(String sessionId) throws IOException {
        // è·å–å¹¶å‘è®¸å¯ï¼ˆé˜»å¡ç­‰å¾…ï¼‰
        concurrencySemaphore.acquire();

        // åˆ›å»ºWorkerè¿›ç¨‹
        // ...

        return worker;
    }

    public void releaseConcurrency() {
        concurrencySemaphore.release();
    }
}
```

**ä¼˜åŠ¿**ï¼š
- é™åˆ¶åŒæ—¶è¿è¡Œçš„è¿›ç¨‹æ•°ï¼ˆé»˜è®¤10ä¸ªï¼‰
- é¿å…ç³»ç»Ÿè¿‡è½½
- æŒ‰éœ€åˆ›å»º,èµ„æºé«˜æ•ˆ

---

## 4. æ ¸å¿ƒå®ç°

### 4.1 ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | è¡Œå· | ä½œç”¨ |
|------|---------|------|------|
| `ClaudeCodeProcessPool.java` | æ–°å¢ `checkSessionExists()` å’Œ `createWorker()` | 106-189 | æ£€æŸ¥ä¼šè¯æ–‡ä»¶å¹¶é€‰æ‹©å‚æ•° |
| `ClaudeCodeProcessPool.java` | æ–°å¢ `acquireConcurrency()` å’Œ `releaseConcurrency()` | 278-287 | å¹¶å‘æ§åˆ¶ |
| `QuickAnalysisController.java` | è°ƒç”¨ `createWorker()` è€Œé `acquireWorker()` | 67 | æŒ‰éœ€åˆ›å»ºè¿›ç¨‹ |
| `ClaudeCodeWorker.java` | ç®€åŒ–ä¸ºå•æ¬¡æ‰§è¡Œæ¨¡å¼ | 133-259 | å‘é€æ¶ˆæ¯,è¿›ç¨‹è‡ªç„¶é€€å‡º |

---

### 4.2 ClaudeCodeProcessPool.java (æ ¸å¿ƒé€»è¾‘)

#### å…³é”®æ–¹æ³•1: æ£€æŸ¥ä¼šè¯æ˜¯å¦å­˜åœ¨

```java
/**
 * æ£€æŸ¥ä¼šè¯æ˜¯å¦å­˜åœ¨ï¼ˆé€šè¿‡æ£€æŸ¥ä¼šè¯æ–‡ä»¶ï¼‰
 *
 * @param sessionId ä¼šè¯ID
 * @return true å¦‚æœä¼šè¯æ–‡ä»¶å­˜åœ¨
 */
private boolean checkSessionExists(String sessionId) {
    try {
        // Claude Code ä¼šè¯æ–‡ä»¶è·¯å¾„ï¼š~/.claude/projects/-<encoded-path>/<sessionId>.jsonl
        String projectPath = workDirBase.replace("/", "-");
        if (projectPath.startsWith("/")) {
            projectPath = "-" + projectPath.substring(1); // ç¡®ä¿ä»¥ "-" å¼€å¤´
        }

        File sessionFile = new File(
            System.getProperty("user.home"),
            ".claude/projects/" + projectPath + "/" + sessionId + ".jsonl"
        );

        boolean exists = sessionFile.exists();
        log.debug("ğŸ” æ£€æŸ¥ä¼šè¯æ–‡ä»¶: {} -> {}", sessionFile.getAbsolutePath(), exists ? "å­˜åœ¨" : "ä¸å­˜åœ¨");
        return exists;

    } catch (Exception e) {
        log.warn("âš ï¸ æ£€æŸ¥ä¼šè¯æ–‡ä»¶å¤±è´¥: {}", e.getMessage());
        return false;
    }
}
```

**å…³é”®ç‚¹**ï¼š
- ä¼šè¯æ–‡ä»¶è·¯å¾„è§„åˆ™ï¼š`~/.claude/projects/-<encoded-project-path>/<sessionId>.jsonl`
- é¡¹ç›®è·¯å¾„éœ€è¦æ›¿æ¢ `/` ä¸º `-`ï¼Œå¹¶æ·»åŠ  `-` å‰ç¼€
- ä¾‹å¦‚ï¼š`/Users/liuchao/projects/sman/agent` â†’ `-Users-liuchao-projects-sman-agent`

#### å…³é”®æ–¹æ³•2: åˆ›å»ºWorkerï¼ˆæ™ºèƒ½é€‰æ‹©å‚æ•°ï¼‰

```java
/**
 * åˆ›å»º workerï¼ˆç”¨äºå•æ¬¡è¯·æ±‚ï¼‰
 *
 * @param sessionId ä¼šè¯ID
 * @return Workerè¿›ç¨‹
 * @throws IOException åˆ›å»ºå¤±è´¥
 */
public ClaudeCodeWorker createWorker(String sessionId) throws IOException {
    String workerId = "worker-" + UUID.randomUUID().toString().substring(0, 8);

    log.info("ğŸš€ åˆ›å»ºWorkerè¿›ç¨‹: workerId={}, sessionId={}", workerId, sessionId);

    // â­ æ£€æŸ¥ä¼šè¯æ˜¯å¦å·²å­˜åœ¨
    boolean sessionExists = checkSessionExists(sessionId);

    // â­ æ„å»ºå‘½ä»¤ï¼šç¬¬1æ¬¡ç”¨ --session-idï¼Œåç»­ç”¨ --resume
    ProcessBuilder pb;
    if (sessionExists) {
        log.info("ğŸ“‹ ä¼šè¯å·²å­˜åœ¨ï¼Œä½¿ç”¨ --resume å‚æ•° (sessionId={})", sessionId);
        pb = new ProcessBuilder(claudeCodePath, "--resume", sessionId, "--print");
    } else {
        log.info("ğŸ†• æ–°ä¼šè¯ï¼Œä½¿ç”¨ --session-id å‚æ•° (sessionId={})", sessionId);
        pb = new ProcessBuilder(claudeCodePath, "--session-id", sessionId, "--print");
    }

    pb.directory(new File(workDirBase));
    pb.redirectErrorStream(true);
    pb.redirectInput(ProcessBuilder.Redirect.PIPE);

    // è¾“å‡ºå®é™…å‘½ä»¤ï¼ˆç”¨äºè°ƒè¯•ï¼‰
    log.info("ğŸ”§ æ‰§è¡Œå‘½ä»¤: {}",
        String.join(" ", pb.command()) + " (å·¥ä½œç›®å½•: " + workDirBase + ")");

    Process process = pb.start();

    // ç­‰å¾…è¿›ç¨‹å¯åŠ¨
    try {
        Thread.sleep(1000);
    } catch (InterruptedException e) {
        Thread.currentThread().interrupt();
    }

    ClaudeCodeWorker worker = new ClaudeCodeWorker(
            workerId,
            workDirBase,
            process,
            System.currentTimeMillis()
    );

    // æ£€æŸ¥è¿›ç¨‹æ˜¯å¦æˆåŠŸå¯åŠ¨
    if (process.isAlive()) {
        worker.setReady(true);
        activeProcesses.incrementAndGet();
        totalRequests.incrementAndGet();
        log.info("âœ… Worker {} å¯åŠ¨æˆåŠŸ (sessionId={}, æ´»è·ƒè¿›ç¨‹æ•°={})",
                 workerId, sessionId, activeProcesses.get());
    } else {
        throw new IOException("Workerè¿›ç¨‹å¯åŠ¨å¤±è´¥ï¼Œç«‹å³é€€å‡º");
    }

    return worker;
}
```

**å…³é”®ç‚¹**ï¼š
- **ç¬¬ä¸€æ¬¡è¯·æ±‚**ï¼š`--session-id <UUID>` åˆ›å»ºæ–°ä¼šè¯
- **åç»­è¯·æ±‚**ï¼š`--resume <UUID>` æ¢å¤ç°æœ‰ä¼šè¯
- CLIè‡ªåŠ¨å¤„ç†ä¼šè¯æ–‡ä»¶çš„è¯»å†™
- Workerè¿›ç¨‹æ‰§è¡Œå®Œè¯·æ±‚åè‡ªç„¶é€€å‡º

#### å…³é”®æ–¹æ³•3: å¹¶å‘æ§åˆ¶

```java
/**
 * è·å–å¹¶å‘è®¸å¯ï¼ˆé˜»å¡ç­‰å¾…ï¼‰
 */
public void acquireConcurrency() throws InterruptedException {
    concurrencySemaphore.acquire();
}

/**
 * é‡Šæ”¾å¹¶å‘è®¸å¯
 */
public void releaseConcurrency() {
    concurrencySemaphore.release();
}

/**
 * æ ‡è®°Workerç»“æŸï¼ˆè¿›ç¨‹é€€å‡ºåè°ƒç”¨ï¼‰
 */
public void markWorkerCompleted(ClaudeCodeWorker worker) {
    activeProcesses.decrementAndGet();
    log.info("âœ… Worker {} å®Œæˆ (æ´»è·ƒè¿›ç¨‹æ•°={})",
             worker.getWorkerId(), activeProcesses.get());
}
```

---

### 4.3 QuickAnalysisController.java (è°ƒç”¨é€»è¾‘)

```java
@PostMapping("/chat")
public Map<String, Object> chat(@RequestBody Map<String, Object> request) {
    String sessionId = (String) request.get("sessionId");
    String message = (String) request.get("message");
    String projectKey = (String) request.getOrDefault("projectKey", "test");

    ClaudeCodeWorker worker = null;

    try {
        // æ„å»ºå‘é€ç»™ Claude Code çš„æ¶ˆæ¯
        String claudeMessage = buildClaudeMessage(message, projectKey, sessionId);

        // â­ è·å–å¹¶å‘è®¸å¯ï¼ˆé™åˆ¶åŒæ—¶è¿è¡Œçš„è¿›ç¨‹æ•°ï¼‰
        processPool.acquireConcurrency();

        try {
            // â­ åˆ›å»ºWorkerè¿›ç¨‹ï¼ˆä½¿ç”¨ --resume æˆ– --session-id å‚æ•°ï¼‰
            worker = processPool.createWorker(sessionId);

            // â­ å‘é€ç»™ Claude Code å¹¶è·å–å“åº”
            String claudeResponse = worker.sendAndReceive(claudeMessage, 120);

            // æ„å»ºå“åº”
            Map<String, Object> response = new HashMap<>();
            response.put("sessionId", sessionId);
            response.put("answer", claudeResponse);
            response.put("workerId", worker.getWorkerId());
            response.put("timestamp", System.currentTimeMillis());

            return response;

        } finally {
            // â­ é‡Šæ”¾å¹¶å‘è®¸å¯
            processPool.releaseConcurrency();

            // â­ æ ‡è®°Workerå®Œæˆ
            if (worker != null) {
                processPool.markWorkerCompleted(worker);
            }
        }

    } catch (Exception e) {
        // é”™è¯¯å¤„ç†
        Map<String, Object> error = new HashMap<>();
        error.put("error", e.getMessage());
        return error;
    }
}
```

**å…³é”®ç‚¹**ï¼š
- ä½¿ç”¨ `createWorker()` è€Œé `acquireWorker()`
- æ¯æ¬¡è¯·æ±‚åˆ›å»ºæ–°è¿›ç¨‹,æ‰§è¡Œå®Œè‡ªåŠ¨é€€å‡º
- é€šè¿‡ Semaphore æ§åˆ¶å¹¶å‘æ•°

---

### 4.4 ClaudeCodeWorker.java (å•æ¬¡æ‰§è¡Œæ¨¡å¼)

```java
/**
 * å‘é€æ¶ˆæ¯ç»™ Claude Code å¹¶è·å–å“åº”
 *
 * @param message ç”¨æˆ·æ¶ˆæ¯
 * @param timeoutSeconds è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
 * @return Claude Code çš„å“åº”
 */
public String sendAndReceive(String message, long timeoutSeconds)
        throws InterruptedException, java.util.concurrent.TimeoutException {

    // æ¯æ¬¡è°ƒç”¨æ—¶åˆ›å»ºæ–°çš„IOæµ
    final BufferedReader[] readerHolder = new BufferedReader[1];
    final BufferedWriter[] writerHolder = new BufferedWriter[1];

    try {
        readerHolder[0] = new BufferedReader(new InputStreamReader(process.getInputStream()));
        writerHolder[0] = new BufferedWriter(new OutputStreamWriter(process.getOutputStream()));

        // ... å¯åŠ¨è¯»å–çº¿ç¨‹ ...

        // å‘é€æ¶ˆæ¯åˆ° stdinï¼ˆsessionId å·²é€šè¿‡ --resume æˆ– --session-id å‚æ•°ä¼ é€’ï¼‰
        writerHolder[0].write(message);
        writerHolder[0].newLine();
        writerHolder[0].flush();

        // â­ å…³é—­writerä»¥å‘é€EOFä¿¡å·ï¼ˆ--print æ¨¡å¼éœ€è¦EOFæ‰å¼€å§‹å¤„ç†ï¼‰
        writerHolder[0].close();
        log.info("âœ… Worker {} æ¶ˆæ¯å·²å‘é€åˆ° Claude Code stdin (EOF sent)", workerId);

        // ç­‰å¾…å“åº”
        // ...

        return response;

    } finally {
        // å…³é—­IOæµ
        if (readerHolder[0] != null) readerHolder[0].close();
        if (writerHolder[0] != null) writerHolder[0].close();
    }
}
```

**å…³é”®ç‚¹**ï¼š
- å…³é—­ writer å‘é€ EOF ä¿¡å·
- è¿›ç¨‹æ”¶åˆ° EOF åè‡ªç„¶é€€å‡º
- æ— éœ€æ‰‹åŠ¨ kill è¿›ç¨‹

---

## 5. é€šä¿¡æµç¨‹

### 5.1 ç¬¬ä¸€è½®å¯¹è¯ï¼ˆåˆ›å»ºä¼šè¯ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 1: å‰ç«¯å‘é€è¯·æ±‚                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ POST /api/analysis/chat                                     â”‚
â”‚ {                                                            â”‚
â”‚   "message": "è®°ä½ï¼šæˆ‘æœ€å–œæ¬¢çš„é¢œè‰²æ˜¯è“è‰²",                   â”‚
â”‚   "sessionId": "8A7F9E2C-3B4D-4F6E-8A9B-1C2D3E4F5A6B",      â”‚
â”‚   "projectKey": "autoloop"                                  â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 2: QuickAnalysisController                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. æ¥æ”¶è¯·æ±‚å‚æ•°                                              â”‚
â”‚ 2. è°ƒç”¨ processPool.createWorker(sessionId)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 3: ClaudeCodeProcessPool                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. è°ƒç”¨ checkSessionExists(sessionId)                       â”‚
â”‚ 2. æ£€æŸ¥ä¼šè¯æ–‡ä»¶ï¼š                                            â”‚
â”‚    ~/.claude/projects/-Users-liuchao-projects-sman-agent/   â”‚
â”‚                8A7F9E2C-3B4D-4F6E-8A9B-1C2D3E4F5A6B.jsonl   â”‚
â”‚ 3. æ–‡ä»¶ä¸å­˜åœ¨ â†’ è¿”å› false                                  â”‚
â”‚ 4. æ„å»ºå‘½ä»¤ï¼šclaude --session-id 8A7F... --print            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 4: å¯åŠ¨ Claude Code CLI è¿›ç¨‹                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. æ‰§è¡Œå‘½ä»¤ï¼š                                                â”‚
â”‚    claude --session-id 8A7F... --print                      â”‚
â”‚ 2. ä» stdin è¯»å–ç”¨æˆ·æ¶ˆæ¯                                     â”‚
â”‚ 3. åˆ›å»ºä¼šè¯æ–‡ä»¶ï¼š8A7F...jsonl                               â”‚
â”‚ 4. è°ƒç”¨ AI API                                              â”‚
â”‚ 5. è¿”å›å“åº”åˆ° stdout                                        â”‚
â”‚ 6. å°†æ¶ˆæ¯å†™å…¥ä¼šè¯æ–‡ä»¶ï¼ˆuser + assistantï¼‰                    â”‚
â”‚ 7. è¿›ç¨‹è‡ªç„¶é€€å‡º                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 5: è¿”å›ç»™å‰ç«¯                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ {                                                            â”‚
â”‚   "sessionId": "8A7F9E2C-3B4D-4F6E-8A9B-1C2D3E4F5A6B",      â”‚
â”‚   "answer": "å¥½çš„ï¼Œæˆ‘è®°ä½äº†ï¼šä½ æœ€å–œæ¬¢çš„é¢œè‰²æ˜¯è“è‰²ã€‚",        â”‚
â”‚   "workerId": "worker-a1b2c3d4",                            â”‚
â”‚   "timestamp": 1767602894231                                â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 ç¬¬äºŒè½®å¯¹è¯ï¼ˆæ¢å¤ä¼šè¯ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 1: å‰ç«¯å‘é€è¯·æ±‚                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ POST /api/analysis/chat                                     â”‚
â”‚ {                                                            â”‚
â”‚   "message": "æˆ‘æœ€å–œæ¬¢çš„é¢œè‰²æ˜¯ä»€ä¹ˆï¼Ÿ",                       â”‚
â”‚   "sessionId": "8A7F9E2C-3B4D-4F6E-8A9B-1C2D3E4F5A6B",      â”‚
â”‚   "projectKey": "autoloop"                                  â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 2: QuickAnalysisController                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. æ¥æ”¶è¯·æ±‚å‚æ•°                                              â”‚
â”‚ 2. è°ƒç”¨ processPool.createWorker(sessionId)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 3: ClaudeCodeProcessPool                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. è°ƒç”¨ checkSessionExists(sessionId)                       â”‚
â”‚ 2. æ£€æŸ¥ä¼šè¯æ–‡ä»¶ï¼š8A7F...jsonl                               â”‚
â”‚ 3. â­ æ–‡ä»¶å­˜åœ¨ â†’ è¿”å› true                                  â”‚
â”‚ 4. â­ æ„å»ºå‘½ä»¤ï¼šclaude --resume 8A7F... --print              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 4: å¯åŠ¨ Claude Code CLI è¿›ç¨‹ (æ¢å¤ä¼šè¯)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. æ‰§è¡Œå‘½ä»¤ï¼š                                                â”‚
â”‚    claude --resume 8A7F... --print                          â”‚
â”‚ 2. â­ è¯»å–ä¼šè¯æ–‡ä»¶ï¼š8A7F...jsonl                            â”‚
â”‚ 3. â­ è§£æå†å²æ¶ˆæ¯ï¼ˆuser + assistantï¼‰                      â”‚
â”‚ 4. â­ é‡å»ºä¸Šä¸‹æ–‡ï¼ˆé€šè¿‡ parentUuid é“¾ï¼‰                      â”‚
â”‚ 5. ä» stdin è¯»å–å½“å‰æ¶ˆæ¯                                     â”‚
â”‚ 6. è°ƒç”¨ AI APIï¼ˆæºå¸¦å†å²ä¸Šä¸‹æ–‡ï¼‰                             â”‚
â”‚ 7. è¿”å›å“åº”åˆ° stdout                                        â”‚
â”‚ 8. â­ è¿½åŠ æ–°æ¶ˆæ¯åˆ°ä¼šè¯æ–‡ä»¶                                   â”‚
â”‚ 9. è¿›ç¨‹è‡ªç„¶é€€å‡º                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 5: è¿”å›ç»™å‰ç«¯                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ {                                                            â”‚
â”‚   "sessionId": "8A7F9E2C-3B4D-4F6E-8A9B-1C2D3E4F5A6B",      â”‚
â”‚   "answer": "æ ¹æ®æˆ‘ä»¬ä¹‹å‰çš„å¯¹è¯ï¼Œä½ æœ€å–œæ¬¢çš„é¢œè‰²æ˜¯è“è‰²ã€‚",    â”‚
â”‚   "workerId": "worker-e5f6g7h8",                            â”‚
â”‚   "timestamp": 1767602956789                                â”‚
â”‚ }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. ä¼šè¯æ–‡ä»¶ç»“æ„

### 6.1 æ–‡ä»¶ä½ç½®

```bash
~/.claude/projects/-Users-liuchao-projects-sman-agent/8A7F9E2C-3B4D-4F6E-8A9B-1C2D3E4F5A6B.jsonl
```

**è·¯å¾„è§„åˆ™**ï¼š
- åŸºç¡€è·¯å¾„ï¼š`~/.claude/projects/`
- é¡¹ç›®è·¯å¾„ç¼–ç ï¼š`/Users/liuchao/projects/sman/agent` â†’ `-Users-liuchao-projects-sman-agent`
- ä¼šè¯æ–‡ä»¶ï¼š`<sessionId>.jsonl`

### 6.2 æ–‡ä»¶æ ¼å¼ï¼ˆJSONLï¼‰

æ¯è¡Œä¸€æ¡æ¶ˆæ¯ï¼ŒJSON æ ¼å¼ï¼š

#### ç¬¬ 1 æ¡æ¶ˆæ¯ï¼ˆuserï¼‰

```json
{
  "parentUuid": null,
  "sessionId": "8A7F9E2C-3B4D-4F6E-8A9B-1C2D3E4F5A6B",
  "type": "user",
  "message": {
    "role": "user",
    "content": "è®°ä½ï¼šæˆ‘æœ€å–œæ¬¢çš„é¢œè‰²æ˜¯è“è‰²\n"
  },
  "uuid": "32eef58b-3d86-443f-8378-d0d0b55966a2",
  "timestamp": "2026-01-05T08:44:26.962Z"
}
```

#### ç¬¬ 2 æ¡æ¶ˆæ¯ï¼ˆassistantï¼‰

```json
{
  "parentUuid": "32eef58b-3d86-443f-8378-d0d0b55966a2",
  "sessionId": "8A7F9E2C-3B4D-4F6E-8A9B-1C2D3E4F5A6B",
  "type": "assistant",
  "message": {
    "id": "msg_2026010516442755e9606027844126",
    "role": "assistant",
    "content": [{"type": "text", "text": "å¥½çš„ï¼Œæˆ‘è®°ä½äº†ã€‚"}]
  },
  "uuid": "8808aa85-6f18-4764-8c3a-9a32f1df8f98",
  "timestamp": "2026-01-05T08:44:30.917Z"
}
```

#### ç¬¬ 3 æ¡æ¶ˆæ¯ï¼ˆç¬¬äºŒè½® userï¼‰

```json
{
  "parentUuid": "8808aa85-6f18-4764-8c3a-9a32f1df8f98",
  "sessionId": "8A7F9E2C-3B4D-4F6E-8A9B-1C2D3E4F5A6B",
  "type": "user",
  "message": {
    "role": "user",
    "content": "æˆ‘æœ€å–œæ¬¢çš„é¢œè‰²æ˜¯ä»€ä¹ˆï¼Ÿ\n"
  },
  "uuid": "new-uuid-123",
  "timestamp": "2026-01-05T08:45:00.000Z"
}
```

### 6.3 æ¶ˆæ¯é“¾ç»“æ„

```
null (parentUuid of ç¬¬1æ¡)
  â†“
ç¬¬1æ¡æ¶ˆæ¯ (uuid: 32eef58b...)  â† "è®°ä½ï¼šæˆ‘æœ€å–œæ¬¢çš„é¢œè‰²æ˜¯è“è‰²"
  â†“
ç¬¬2æ¡æ¶ˆæ¯ (parentUuid: 32eef58b...)  â† "å¥½çš„ï¼Œæˆ‘è®°ä½äº†ã€‚"
  â†“
ç¬¬3æ¡æ¶ˆæ¯ (parentUuid: 8808aa85...)  â† "æˆ‘æœ€å–œæ¬¢çš„é¢œè‰²æ˜¯ä»€ä¹ˆï¼Ÿ"
  â†“
ç¬¬4æ¡æ¶ˆæ¯ (parentUuid: new-uuid-123...)  â† "æ˜¯è“è‰²"
  â†“
...
```

**å…³é”®ç‚¹**ï¼š
- `parentUuid` å½¢æˆæ¶ˆæ¯é“¾ï¼ˆå¯¹è¯å†å²ï¼‰
- Claude Code æ ¹æ® `parentUuid` é“¾é‡å»ºä¸Šä¸‹æ–‡
- ä½¿ç”¨ `--resume` æ—¶ï¼ŒCLIè‡ªåŠ¨åŠ è½½å¹¶è§£ææ•´ä¸ªæ¶ˆæ¯é“¾

---

## 7. æµ‹è¯•æ–¹æ³•

### 7.1 ç¬¬ä¸€è½®å¯¹è¯ï¼ˆå»ºç«‹è®°å¿†ï¼‰

```bash
curl -X POST http://localhost:8080/api/analysis/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "è®°ä½ï¼šæˆ‘æœ€å–œæ¬¢çš„é¢œè‰²æ˜¯è“è‰²",
    "projectKey": "autoloop",
    "sessionId": "8A7F9E2C-3B4D-4F6E-8A9B-1C2D3E4F5A6B"
  }'
```

**æœŸæœ›å“åº”**ï¼š
```json
{
  "sessionId": "8A7F9E2C-3B4D-4F6E-8A9B-1C2D3E4F5A6B",
  "answer": "å¥½çš„ï¼Œæˆ‘è®°ä½äº†ï¼šä½ æœ€å–œæ¬¢çš„é¢œè‰²æ˜¯è“è‰²ã€‚",
  "workerId": "worker-a1b2c3d4",
  "timestamp": 1767602894231
}
```

**éªŒè¯ä¼šè¯æ–‡ä»¶**ï¼š
```bash
# æŸ¥æ‰¾ä¼šè¯æ–‡ä»¶
ls -la ~/.claude/projects/-Users-liuchao-projects-sman-agent/

# æŸ¥çœ‹ä¼šè¯å†…å®¹ï¼ˆæ ¼å¼åŒ–ï¼‰
cat ~/.claude/projects/-Users-liuchao-projects-sman-agent/8A7F9E2C-3B4D-4F6E-8A9B-1C2D3E4F5A6B.jsonl | \
  python3 -m json.tool
```

### 7.2 ç¬¬äºŒè½®å¯¹è¯ï¼ˆéªŒè¯è®°å¿†ï¼‰

```bash
curl -X POST http://localhost:8080/api/analysis/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "æˆ‘æœ€å–œæ¬¢çš„é¢œè‰²æ˜¯ä»€ä¹ˆï¼Ÿ",
    "projectKey": "autoloop",
    "sessionId": "8A7F9E2C-3B4D-4F6E-8A9B-1C2D3E4F5A6B"
  }'
```

**æœŸæœ›å“åº”**ï¼š
```json
{
  "sessionId": "8A7F9E2C-3B4D-4F6E-8A9B-1C2D3E4F5A6B",
  "answer": "æ ¹æ®æˆ‘ä»¬ä¹‹å‰çš„å¯¹è¯ï¼Œä½ æœ€å–œæ¬¢çš„é¢œè‰²æ˜¯è“è‰²ã€‚",
  "workerId": "worker-e5f6g7h8",
  "timestamp": 1767602956789
}
```

**éªŒè¯ä¼šè¯æ–‡ä»¶**ï¼š
```bash
# æŸ¥çœ‹ä¼šè¯æ–‡ä»¶ï¼ˆåº”è¯¥æœ‰ 4 æ¡æ¶ˆæ¯ï¼‰
cat ~/.claude/projects/-Users-liuchao-projects-sman-agent/8A7F9E2C-3B4D-4F6E-8A9B-1C2D3E4F5A6B.jsonl | \
  python3 -c "import sys, json; lines = list(sys.stdin); print(f'Total messages: {len(lines)}')"
```

### 7.3 ç¬¬ä¸‰è½®å¯¹è¯ï¼ˆä½¿ç”¨ä¸åŒ sessionIdï¼‰

```bash
curl -X POST http://localhost:8080/api/analysis/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "æˆ‘æœ€å–œæ¬¢çš„é¢œè‰²æ˜¯ä»€ä¹ˆï¼Ÿ",
    "projectKey": "autoloop",
    "sessionId": "B8F6E3D1-4C5A-2B9F-7E8D-1A2C3B4D5E6F"
  }'
```

**æœŸæœ›å“åº”**ï¼š
```json
{
  "sessionId": "B8F6E3D1-4C5A-2B9F-7E8D-1A2C3B4D5E6F",
  "answer": "æˆ‘ä¸çŸ¥é“ä½ å–œæ¬¢çš„é¢œè‰²ã€‚",
  "workerId": "worker-i9j0k1l2",
  "timestamp": 1767603012345
}
```

---

## 8. å…³é”®å‚æ•°è¯´æ˜

### 8.1 `--session-id <UUID>`

| å±æ€§ | è¯´æ˜ |
|------|------|
| **ä½œç”¨** | åˆ›å»ºæ–°ä¼šè¯ï¼Œå…³è”åˆ°ä¼šè¯æ–‡ä»¶ |
| **æ ¼å¼** | å¿…é¡»æ˜¯æœ‰æ•ˆçš„ UUID |
| **è¡Œä¸º** | æ€»æ˜¯åˆ›å»ºæ–°ä¼šè¯æ–‡ä»¶ï¼ˆå³ä½¿å·²å­˜åœ¨ï¼‰ |
| **ä½¿ç”¨åœºæ™¯** | ç¬¬ä¸€æ¬¡è¯·æ±‚ï¼ˆä¼šè¯æ–‡ä»¶ä¸å­˜åœ¨ï¼‰ |

### 8.2 `--resume <UUID>`

| å±æ€§ | è¯´æ˜ |
|------|------|
| **ä½œç”¨** | æ¢å¤ç°æœ‰ä¼šè¯ï¼ŒåŠ è½½å†å²æ¶ˆæ¯ |
| **æ ¼å¼** | å¿…é¡»æ˜¯æœ‰æ•ˆçš„ UUID |
| **è¡Œä¸º** | è¯»å–ä¼šè¯æ–‡ä»¶ï¼Œé‡å»ºä¸Šä¸‹æ–‡ |
| **ä½¿ç”¨åœºæ™¯** | åç»­è¯·æ±‚ï¼ˆä¼šè¯æ–‡ä»¶å·²å­˜åœ¨ï¼‰ |

### 8.3 `--print`

| å±æ€§ | è¯´æ˜ |
|------|------|
| **ä½œç”¨** | å•æ¬¡æ‰§è¡Œæ¨¡å¼ |
| **è¡Œä¸º** | ä» stdin è¯»å–æ¶ˆæ¯ï¼Œå¤„ç†å®Œåé€€å‡º |
| **å…³é”®** | éœ€è¦å‘é€ EOF ä¿¡å·æ‰å¼€å§‹å¤„ç† |

---

## 9. ä¼šè¯ç”Ÿå‘½å‘¨æœŸ

```
ç”¨æˆ·å‘é€ç¬¬1æ¬¡è¯·æ±‚ (sessionId = "test-001")
  â†“
Agentæ£€æµ‹åˆ°ä¼šè¯æ–‡ä»¶ä¸å­˜åœ¨
  â†“
ä½¿ç”¨ --session-id åˆ›å»ºæ–°ä¼šè¯
  â†“
Claude Code åˆ›å»ºä¼šè¯æ–‡ä»¶ï¼štest-001.jsonl
  â†“
å†™å…¥æ¶ˆæ¯1ï¼ˆuserï¼‰+ å›å¤1ï¼ˆassistantï¼‰
  â†“
Workerè¿›ç¨‹é€€å‡º
  â†“
âœ… ä¼šè¯æ–‡ä»¶å·²ä¿å­˜
  â†“
ç”¨æˆ·å‘é€ç¬¬2æ¬¡è¯·æ±‚ (sessionId = "test-001")
  â†“
Agentæ£€æµ‹åˆ°ä¼šè¯æ–‡ä»¶å­˜åœ¨
  â†“
ä½¿ç”¨ --resume æ¢å¤ä¼šè¯
  â†“
Claude Code åŠ è½½ test-001.jsonl
  â†“
è¯»å–å†å²æ¶ˆæ¯ï¼ˆé€šè¿‡ parentUuid é“¾ï¼‰
  â†“
å¤„ç†ç¬¬2æ¬¡è¯·æ±‚ï¼ˆèƒ½çœ‹åˆ°ç¬¬1æ¬¡çš„ä¸Šä¸‹æ–‡ï¼‰
  â†“
è¿½åŠ æ¶ˆæ¯2ï¼ˆuserï¼‰+ å›å¤2ï¼ˆassistantï¼‰
  â†“
Workerè¿›ç¨‹é€€å‡º
  â†“
âœ… ä¼šè¯æ–‡ä»¶å·²æ›´æ–°
  â†“
...ï¼ˆæŒç»­å¯¹è¯ï¼‰
  â†“
ä¼šè¯è¿‡æœŸï¼ˆ24å°æ—¶åï¼‰â†’ åˆ é™¤æˆ–å½’æ¡£
```

---

## 10. æ•…éšœæ’æŸ¥

### 10.1 ç¬¬äºŒè½®å¯¹è¯æ²¡æœ‰è®°å¿†

**é—®é¢˜**ï¼šä½¿ç”¨ç›¸åŒçš„ sessionIdï¼Œä½†æ²¡æœ‰è®°ä½ä¹‹å‰çš„å†…å®¹

**æ’æŸ¥æ­¥éª¤**ï¼š
```bash
# 1. æ£€æŸ¥ä¼šè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la ~/.claude/projects/-<project-path>/<sessionId>.jsonl

# 2. æŸ¥çœ‹ä¼šè¯æ–‡ä»¶å†…å®¹
cat ~/.claude/projects/-<project-path>/<sessionId>.jsonl | \
  python3 -c "import sys, json; lines = list(sys.stdin); print(f'Total messages: {len(lines)}')"

# 3. æ£€æŸ¥æ—¥å¿—
tail -f logs/app.log | grep -E "(ä¼šè¯å·²å­˜åœ¨|æ–°ä¼šè¯|--resume|--session-id)"
```

**å¯èƒ½åŸå› **ï¼š
- sessionId ä¸åŒï¼ˆå¤§å°å†™æ•æ„Ÿï¼‰
- ä¼šè¯æ–‡ä»¶è¢«åˆ é™¤
- é¡¹ç›®è·¯å¾„ç¼–ç ä¸æ­£ç¡®

### 10.2 ä¼šè¯æ–‡ä»¶è·¯å¾„é”™è¯¯

**é—®é¢˜**ï¼šCLIæ‰¾ä¸åˆ°ä¼šè¯æ–‡ä»¶

**æ’æŸ¥æ­¥éª¤**ï¼š
```bash
# 1. æ£€æŸ¥ workDirBase é…ç½®
grep workDirBase application.properties

# 2. æ‰‹åŠ¨è®¡ç®—è·¯å¾„
echo "/Users/liuchao/projects/sman/agent" | sed 's/\//-/g' | sed 's/^-/-/'

# 3. æŸ¥æ‰¾å®é™…çš„ä¼šè¯æ–‡ä»¶
find ~/.claude/projects -name "<sessionId>.jsonl"
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®ä¿è·¯å¾„ç¼–ç æ­£ç¡®ï¼ˆ`/` â†’ `-`ï¼Œæ·»åŠ  `-` å‰ç¼€ï¼‰
- æ£€æŸ¥ workDirBase é…ç½®æ˜¯å¦æ­£ç¡®

### 10.3 å¹¶å‘é™åˆ¶å¯¼è‡´é˜»å¡

**é—®é¢˜**ï¼šè¯·æ±‚ä¸€ç›´ç­‰å¾…ï¼Œæ²¡æœ‰å“åº”

**æ’æŸ¥æ­¥éª¤**ï¼š
```bash
# 1. æŸ¥çœ‹æ´»è·ƒè¿›ç¨‹æ•°
curl http://localhost:8080/api/claude-code/pool/status

# 2. æŸ¥çœ‹æ—¥å¿—
tail -f logs/app.log | grep "ç­‰å¾…å¹¶å‘è®¸å¯"
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- è°ƒæ•´ `claude-code.concurrent.limit` é…ç½®
- æ£€æŸ¥æ˜¯å¦æœ‰è¿›ç¨‹å¡ä½

---

## 11. æ€»ç»“

### 11.1 æ ¸å¿ƒåŸç†

**å¤šè½®å¯¹è¯ = ä¼šè¯æ–‡ä»¶æŒä¹…åŒ– + --resume æ¢å¤**

1. **ç¬¬ä¸€æ¬¡è¯·æ±‚**ï¼šä½¿ç”¨ `--session-id` åˆ›å»ºæ–°ä¼šè¯
2. **åç»­è¯·æ±‚**ï¼šä½¿ç”¨ `--resume` æ¢å¤ä¼šè¯
3. **ä¼šè¯æ–‡ä»¶**ï¼šè‡ªåŠ¨ä¿å­˜å¯¹è¯å†å²
4. **ä¸Šä¸‹æ–‡è®°å¿†**ï¼šCLIè‡ªåŠ¨åŠ è½½å’Œç®¡ç†

### 11.2 å…³é”®ä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **âœ… ç®€å•ä¼˜é›…** | åˆ©ç”¨CLIåŸç”ŸåŠŸèƒ½ï¼Œæ— éœ€è‡ªå·±ç®¡ç†ä¼šè¯ |
| **âœ… èµ„æºé«˜æ•ˆ** | æŒ‰éœ€åˆ›å»ºè¿›ç¨‹ï¼Œæ— éœ€ä¿æŒé•¿è¿æ¥ |
| **âœ… å¹¶å‘æ§åˆ¶** | ä½¿ç”¨ Semaphore é™åˆ¶å¹¶å‘æ•° |
| **âœ… ä¼šè¯æŒä¹…åŒ–** | CLIè‡ªåŠ¨ç®¡ç†ä¼šè¯æ–‡ä»¶ |
| **âœ… æ— é”å®šé—®é¢˜** | æ¯æ¬¡ç‹¬ç«‹è¿›ç¨‹ï¼Œé¿å…CLIå†…éƒ¨é” |

### 11.3 ä½¿ç”¨ç¤ºä¾‹

```bash
# ç¬¬1è½®ï¼šå»ºç«‹è®°å¿†
curl -X POST http://localhost:8080/api/analysis/chat \
  -H "Content-Type: application/json" \
  -d '{"message":"æˆ‘æ˜¯ SiliconMan","projectKey":"test","sessionId":"8A7F9E2C..."}'

# ç¬¬2è½®ï¼šéªŒè¯è®°å¿†
curl -X POST http://localhost:8080/api/analysis/chat \
  -H "Content-Type: application/json" \
  -d '{"message":"æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ","projectKey":"test","sessionId":"8A7F9E2C..."}'

# âœ… å›å¤ï¼š"ä½ å« SiliconMan"
```

---

**æ–‡æ¡£ç‰ˆæœ¬å†å²**ï¼š
- v1.0 (2026-01-05): åˆå§‹ç‰ˆæœ¬ï¼ˆåŸºäº `/tmp/claude-code-stdio` è„šæœ¬ï¼‰
- v2.0 (2026-01-05): Finalç‰ˆæœ¬ï¼ˆåŸºäº `--resume` æŒ‰éœ€åˆ›å»ºè¿›ç¨‹ï¼‰âœ…

**æ–‡æ¡£ç»“æŸ**
